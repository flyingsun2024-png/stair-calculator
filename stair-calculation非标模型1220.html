<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥¼æ¢¯åˆ†æ®µæµ‹ç®—ç³»ç»Ÿ V7.0 - å¤šæ¢¯æ®µæ•´åˆç‰ˆ</title>
    
    <!-- æ•°å­¦å…¬å¼æ¸²æŸ“ -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- å¯¼å‡ºåŠŸèƒ½æ‰€éœ€åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
    /* ========== åŸºç¡€æ ·å¼ ========== */
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #10b981;
        --accent: #f59e0b;
        --light: #f8fafc;
        --dark: #1e293b;
        --gray: #64748b;
        --gray-light: #e2e8f0;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: var(--dark);
        line-height: 1.6;
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    h1 {
        color: var(--dark);
        text-align: center;
        margin-bottom: 30px;
        font-weight: 800;
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding: 20px 0;
        position: relative;
    }

    h1::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 2px;
    }

    /* ========== æ­¥éª¤æŒ‡ç¤ºå™¨ ========== */
    .step-indicator {
        display: flex;
        margin-bottom: 30px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .step-item {
        flex: 1;
        text-align: center;
        padding: 20px;
        background: var(--light);
        color: var(--gray);
        font-weight: bold;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .step-item.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .step-item.completed {
        background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
        color: white;
    }

    /* ========== æ­¥éª¤å†…å®¹å®¹å™¨ ========== */
    .step-box {
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .step-active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ========== å¤šæ¢¯æ®µé…ç½®æ ·å¼ ========== */
    /* ç»“æ„å¡ç‰‡æ ·å¼ */
    .struct-card { 
        background: white; 
        border-radius: var(--border-radius); 
        padding: 24px; 
        margin-bottom: 20px;
        border-left: 10px solid #ccc; 
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        position: relative;
    }
    
    .struct-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }
    
    .struct-start { border-left-color: var(--primary); }
    .struct-middle { border-left-color: var(--secondary); }
    .struct-exit { border-left-color: var(--accent); }

    .card-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 1px solid var(--gray-light); 
        padding-bottom: 15px; 
        margin-bottom: 20px;
    }

    .card-header strong {
        font-size: 1.2rem;
        color: var(--dark);
    }

    /* é€»è¾‘é¡ºåºæ ‡è®° */
    .logic-order {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        box-shadow: var(--shadow);
        z-index: 1;
    }

    /* å‚æ•°ç½‘æ ¼ - è°ƒæ•´ä¸º4åˆ— */
    .param-inner-grid {
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 20px;
    }
    
    .input-group { 
        display: flex; 
        flex-direction: column; 
    }
    
    .input-group label { 
        font-size: 0.9rem; 
        margin-bottom: 8px; 
        color: var(--gray); 
        font-weight: 600; 
    }
    
    .input-group input { 
        padding: 12px 16px; 
        border: 2px solid var(--gray-light); 
        border-radius: 8px; 
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .input-group input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }

    .model-select {
        padding: 10px 20px;
        border: 2px solid var(--gray-light);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        background: white;
        color: var(--dark);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .model-select:hover {
        border-color: var(--primary);
    }
    
    .model-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* ========== æŒ‰é’®æ ·å¼ ========== */
    .btn { 
        padding: 14px 28px; 
        border-radius: var(--border-radius); 
        border: none; 
        cursor: pointer; 
        font-weight: 700; 
        transition: all 0.3s ease; 
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-next { 
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
        color: white; 
    }
    
    .btn-prev {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
    }
    
    .btn-add { 
        background: white; 
        border: 2px dashed var(--gray-light); 
        color: var(--gray); 
        margin-right: 10px; 
    }
    
    .btn-add:hover { 
        border-color: var(--secondary); 
        color: var(--secondary); 
    }
    
    .btn-section-nav {
        margin-top: 30px;
        display: flex;
        justify-content: space-between;
    }

    /* ========== v6.1å‚æ•°é…ç½®æ ·å¼ ========== */
    .section {
        border-radius: var(--border-radius);
        padding: 28px;
        margin-bottom: 30px;
        background: white;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border: 1px solid var(--gray-light);
    }
    
    .section:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }
    
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .form-item {
        flex: 1 1 calc(33.333% - 14px);
        min-width: 280px;
    }
    
    .input-group label {
        font-size: 0.95rem;
    }

    /* å•é€‰æŒ‰é’®ç»„æ ·å¼ */
    .radio-group {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 20px;
        border-radius: var(--border-radius);
        background: var(--light);
        border: 1px dashed var(--gray-light);
    }
    
    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 12px 20px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .radio-option:hover {
        background: rgba(79, 70, 229, 0.05);
    }
    
    .radio-option input[type="radio"] {
        width: auto;
        margin: 0;
    }

    /* è®¡ç®—å¸¸é‡è¾“å…¥åŒºåŸŸ */
    #constantsInputArea {
        flex-wrap: wrap;
    }

    /* ========== åšåº¦è¾“å…¥éƒ¨åˆ†ä¸“ç”¨æ ·å¼ ========== */
    .thickness-section {
        margin-top: 20px;
    }

    .thickness-category {
        margin-bottom: 30px;
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 24px;
        border: 1px solid var(--gray-light);
        transition: all 0.3s ease;
    }

    .thickness-category:hover {
        box-shadow: var(--shadow);
    }

    .thickness-category h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--dark);
        font-size: 1.2rem;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .thickness-category h3::before {
        content: '';
        display: block;
        width: 6px;
        height: 20px;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
        border-radius: 3px;
    }

    .thickness-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .thickness-item {
        display: flex;
        flex-direction: column;
        padding: 18px;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--gray-light);
        transition: all 0.2s ease;
    }

    .thickness-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    /* ========== ç»“æœå±•ç¤ºåŒºåŸŸ ========== */
    #resultArea {
        margin-top: 40px;
        padding: 32px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-light);
    }
    
    #resultArea h3 {
        margin-top: 0;
        color: var(--dark);
        font-size: 1.5rem;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--gray-light);
    }

    /* å•æ¢¯æ®µç»“æœå®¹å™¨ */
    .section-result {
        margin-bottom: 30px;
        padding: 20px;
        background: var(--light);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-light);
    }
    
    .section-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        cursor: pointer;
        padding: 10px 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--gray-light);
        transition: all 0.3s ease;
    }
    
    .section-result-header:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow);
    }
    
    .section-result-content {
        display: none;
        padding: 20px;
        background: white;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid var(--gray-light);
    }
    
    .section-result-content.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    /* æ±‡æ€»ç»“æœæ ·å¼ */
    .summary-result {
        margin-top: 30px;
        padding: 25px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: var(--border-radius);
        border: 2px solid var(--primary);
    }
    
    .summary-result h4 {
        margin-top: 0;
        color: var(--primary);
        font-size: 1.3rem;
        margin-bottom: 20px;
    }

    /* ========== V6.1 æ ·å¼å¤åˆ¶ ========== */
    .geometric-output-box {
        background-color: #f0f9ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid var(--primary);
    }
    
    .geometric-output-box h4 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        margin-top: 0;
    }
    
    .geometric-output-box p {
        font-size: 1rem !important;
        margin: 8px 0;
    }

    /* é’¢æ¿ç”¨é‡è®¡ç®—å…¬å¼æ ·å¼ */
    .formula-section {
        background-color: #f8fafc;
        padding: 24px;
        border-radius: var(--border-radius);
        margin: 25px 0;
        border: 1px solid var(--gray-light);
    }
    
    .formula-category {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px dashed var(--gray-light);
    }
    
    .formula-category:last-child {
        border-bottom: none;
    }
    
    .formula-category h4 {
        color: var(--dark);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary);
        font-size: 1.2rem;
    }
    
    .formula-item {
        margin-bottom: 20px;
        padding: 16px;
        background-color: white;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
        box-shadow: var(--shadow);
    }
    
    .formula-item h5 {
        margin-top: 0;
        margin-bottom: 12px;
        color: var(--dark);
        font-size: 1.1rem;
    }

    /* å…¬å¼æ˜¾ç¤º/éšè—æŒ‰é’® */
    .toggle-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }
    
    .toggle-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .formula-container {
        display: none;
        text-align: left;
    }
    
    .formula-container.show {
        display: block;
        animation: fadeIn 0.5s ease;
    }

    /* ========== é’¢æ¿ç”¨é‡è®¡ç®—è¡¨æ ¼æ ·å¼ ========== */
    .material-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 24px;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
    }
    
    .material-table th, .material-table td {
        border: 1px solid var(--gray-light);
        padding: 14px 16px;
        text-align: center;
    }

    .material-table th {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        font-weight: 600;
        border: none;
    }

    /* è¡¨å¤´é¢œè‰² */
    .material-table thead th:nth-child(1),
    .material-table thead th:nth-child(2) {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    
    .material-table thead th:nth-child(3) {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .material-table thead th:nth-child(4) {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    /* è¡Œåˆ†ç»„èƒŒæ™¯è‰² */
    .material-table tr:nth-child(4n+3) td, 
    .material-table tr:nth-child(4n+4) td {
        background-color: #f8fafc;
    }

    /* åˆ†ç±»åˆ—å±…ä¸­å‚ç›´å¯¹é½ï¼ŒèƒŒæ™¯è‰²çªå‡º */
    .material-table td:first-child {
        text-align: center;
        vertical-align: middle;
        font-weight: 700;
        background: #f1f5f9 !important;
    }

    /* åç§°æ å¼ºåˆ¶é å·¦å¯¹é½ */
    .material-table td:nth-child(2),
    .material-table td:nth-child(3) {
        text-align: center !important;
    }

    /* æ±‡æ€»è¡Œæ ·å¼ */
    .material-table .total-row td {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .total-row .total-label {
        text-align: center;
        font-size: 1.2rem;
    }
    
    .total-row .final-weight {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        color: white;
        font-size: 1.3rem;
        text-align: right !important;
    }

    /* ========== å¯¼å‡ºæŒ‰é’®æ ·å¼ ========== */
    .export-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 30px 0;
        flex-wrap: wrap;
    }

    .export-btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        min-width: 200px;
        justify-content: center;
    }

    .export-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .export-btn.excel {
        background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        color: white;
    }

    .export-btn.txt {
        background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
        color: white;
    }

    .export-btn .icon {
        font-size: 20px;
    }

    /* ========== åŠ è½½åŠ¨ç”» ========== */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ========== æˆåŠŸæç¤º ========== */
    .success-message {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow);
    }
    
    .success-message::before {
        content: 'âœ“';
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* ========== ä¿¡æ¯æç¤º ========== */
    .info-message {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow);
    }
    
    .info-message::before {
        content: 'â„¹ï¸';
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* ========== é…ç½®é¡ºåºæç¤º ========== */
    .order-hint {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        font-size: 0.95rem;
    }
    
    .order-hint h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: white;
        font-size: 1.1rem;
    }

    /* ========== å“åº”å¼è®¾è®¡ ========== */
    @media (max-width: 1200px) {
        .form-item {
            flex: 1 1 calc(50% - 10px);
        }
        
        .param-inner-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 16px;
        }
        
        .form-item {
            flex: 1 1 100%;
        }
        
        .param-inner-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        h1 {
            font-size: 2rem;
        }
        
        .section {
            padding: 20px;
        }
        
        .radio-group {
            flex-direction: column;
            gap: 12px;
        }
        
        .step-indicator {
            flex-direction: column;
        }
        
        .step-item {
            padding: 15px;
        }
        
        #resultArea {
            padding: 20px;
        }
        
        .thickness-grid {
            grid-template-columns: 1fr;
        }
        
        .export-buttons {
            flex-direction: column;
        }
        
        .export-btn {
            min-width: 100%;
        }
    }

    @media (max-width: 480px) {
        .param-inner-grid {
            grid-template-columns: 1fr;
        }
    }
    </style>
</head>

<body>
<div class="container">
    <h1>æ¥¼æ¢¯åˆ†æ®µæµ‹ç®—ç³»ç»Ÿ V7.0 - å¤šæ¢¯æ®µæ•´åˆç‰ˆ</h1>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="step-indicator">
        <div class="step-item active" id="step-indicator-1">1. æ¢¯æ®µç»“æ„é…ç½®</div>
        <div class="step-item" id="step-indicator-2">2. å…¬å…±å‚æ•°é…ç½®</div>
        <div class="step-item" id="step-indicator-3">3. è®¡ç®—ç»“æœ</div>
        <div class="step-item" id="step-indicator-4">4. æ±‡æ€»æŠ¥å‘Š</div>
    </div>

    <!-- ç¬¬ä¸€æ­¥ï¼šå¤šæ¢¯æ®µé…ç½® -->
    <div id="step1" class="step-box step-active">
        <h2>ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæ¥¼æ¢¯æ¢¯æ®µç»“æ„é…ç½®</h2>
        
        <!-- é…ç½®é¡ºåºæç¤º -->
        <div class="order-hint">
            <h4>ğŸ“‹ é…ç½®é¡ºåºæç¤º</h4>
            <p><strong>å»ºè®®é…ç½®é¡ºåºï¼š</strong>èµ·æ­¥æ®µ â†’ ä¸­é—´æ®µ â†’ å‡ºå£æ®µ</p>
            <p><strong>ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰é€»è¾‘é¡ºåºæ’åºæ˜¾ç¤ºï¼Œä½†å»ºè®®æ‚¨æŒ‰æ­¤é¡ºåºé…ç½®ä»¥é¿å…æ··æ·†ã€‚</strong></p>
        </div>
        
        <div id="structure-list">
            <!-- èµ·æ­¥æ®µå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="btn-section-nav">
            <div>
                <button class="btn btn-add" onclick="addNewSection('middle')">â• æ·»åŠ ä¸­é—´æ®µ</button>
                <button class="btn btn-add" onclick="addNewSection('exit')">â• æ·»åŠ å‡ºå£æ®µ</button>
            </div>
            <button class="btn btn-next" onclick="goToStep2()">ç¡®è®¤å¹¶è¿›å…¥ç¬¬äºŒæ­¥ â”</button>
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šå…¬å…±å‚æ•°é…ç½® -->
    <div id="step2" class="step-box">
        <h2>ğŸ“ ç¬¬äºŒæ­¥ï¼šå…¬å…±å‚æ•°é…ç½®</h2>
        <p style="color: var(--gray); margin-bottom: 25px;">ä»¥ä¸‹å‚æ•°ä¸ºæ‰€æœ‰æ¢¯æ®µå…±ç”¨çš„è®¡ç®—å‚æ•°</p>
        
        <!-- æ¥¼æ¢¯ç»“æ„å‚æ•° -->
        <div class="section">
            <h3 style="margin-top: 0; color: var(--primary);">ä¸‰ã€æ¥¼æ¢¯ç»“æ„å‚æ•°</h3>
            
            <div class="form-row">
                <div class="form-item">
                    <label for="outerHandrail">å¤–ä¾§æ‰¶æ‰‹</label>
                    <select id="outerHandrail">
                        <option value="singlePlate">å•é’¢æ¿</option>
                        <option value="glassSlot">ç»ç’ƒæ§½</option>
                        <option value="boxBeam">ç®±ä½“é«˜æ¢</option>
                    </select>
                </div>

                <div class="form-item">
                    <label for="innerHandrail">å†…ä¾§æ‰¶æ‰‹</label>
                    <select id="innerHandrail">
                        <option value="singlePlate">å•é’¢æ¿</option>
                        <option value="glassSlot">ç»ç’ƒæ§½</option>
                        <option value="boxBeam" selected>ç®±ä½“é«˜æ¢</option>
                    </select>
                </div>
                <div class="form-item">
                    <label for="exitLevel">å‡ºå£å¹³å°ä¸åœ°é¢é½å¹³</label>
                    <select id="exitLevel">
                        <option value="yes">æ˜¯</option>
                        <option value="no">å¦</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- è®¡ç®—å¸¸é‡ -->
        <div class="section">
            <h3 style="margin-top: 0; color: var(--secondary);">âš™ï¸ è®¡ç®—å¸¸é‡ï¼ˆé»˜è®¤/è‡ªå®šä¹‰ï¼‰</h3>
            
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="constantsMode" value="default" onchange="switchMode('default', 'constantsInputArea')" checked>
                    <span>ä½¿ç”¨é»˜è®¤å‚æ•°</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="constantsMode" value="custom" onchange="switchMode('custom', 'constantsInputArea')">
                    <span>è‡ªå®šä¹‰å‚æ•°</span>
                </label>
            </div>

            <div class="form-row" id="constantsInputArea" style="display: none;">
                <div class="form-item"><label for="materialDensity">é’¢æå¯†åº¦ ($\rho$)</label><div class="input-group"><input type="number" id="materialDensity" value="7850"><span class="unit-label">kg/mÂ³</span></div></div>
                <div class="form-item"><label for="weldAllowance">ç„Šç¼ä½™é‡</label><input type="number" step="0.01" id="weldAllowance" value="1.05"></div>
                <div class="form-item"><label for="safeFactor">å®‰å…¨ç³»æ•°</label><input type="number" step="0.01" id="safeFactor" value="1.20"></div>
                <div class="form-item"><label for="hanging">ä¸‹æŒ‚</label><div class="input-group"><input type="number" id="hanging" value="130"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="foldingEdge">æŠ˜è¾¹</label><div class="input-group"><input type="number" id="foldingEdge" value="25"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="embedMargin">é¢„åŸ‹æ”¾è¾¹</label><div class="input-group"><input type="number" id="embedMargin" value="60"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="finishThickness">é¥°é¢åšåº¦</label><div class="input-group"><input type="number" id="finishThickness" value="50"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="bottomKeel">å°åº•é¾™éª¨</label><div class="input-group"><input type="number" id="bottomKeel" value="40"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="singlePlateHeight">å•é’¢æ¿å‰å£é«˜åº¦</label><div class="input-group"><input type="number" id="singlePlateHeight" value="1050"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="glassSlotHeight">ç»ç’ƒæ§½å‰å£é«˜åº¦</label><div class="input-group"><input type="number" id="glassSlotHeight" value="100"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="boxThickness">ç®±æ¢åšåº¦</label><div class="input-group"><input type="number" id="boxThickness" value="40"><span class="unit-label">mm</span></div></div>
                <div class="form-item"><label for="exitEmbedWidth">å‡ºå£é¢„åŸ‹æ¿å®½åº¦</label><div class="input-group"><input type="number" id="exitEmbedWidth" value="500"><span class="unit-label">mm</span></div></div> 
            </div>
        </div>

        <!-- é’¢æ¿åšåº¦è¾“å…¥ -->
        <div class="section">
            <h3 style="margin-top: 0; color: var(--accent);">å››ã€é’¢æ¿åšåº¦è¾“å…¥ï¼ˆmmï¼‰</h3>
            
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="thicknessMode" value="default" onchange="switchMode('default', 'thicknessInputArea')" checked>
                    <span>ä½¿ç”¨é»˜è®¤åšåº¦ï¼ˆæ¨èï¼‰</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="thicknessMode" value="custom" onchange="switchMode('custom', 'thicknessInputArea')">
                    <span>è‡ªå®šä¹‰åšåº¦</span>
                </label>
            </div>

            <div id="thicknessInputArea" style="display: none;" class="thickness-section">
                <!-- å¿«é€Ÿè®¾ç½®é€‰é¡¹ -->
                <div class="quick-settings" style="margin-bottom: 20px;">
                    <button type="button" class="btn quick-setting-btn" onclick="applyThicknessProfile('standard')">æ ‡å‡†åšåº¦</button>
                    <button type="button" class="btn quick-setting-btn" onclick="applyThicknessProfile('economical')">ç»æµå‹</button>
                    <button type="button" class="btn quick-setting-btn" onclick="applyThicknessProfile('heavy-duty')">é‡å‹ç»“æ„</button>
                    <button type="button" class="btn reset-thickness" onclick="resetThicknessToDefault()">
                        <span>â†º</span>
                        <span>é‡ç½®ä¸ºé»˜è®¤</span>
                    </button>
                </div>

                <!-- åšåº¦è¾“å…¥åŒºåŸŸå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <div id="thicknessInputsContainer"></div>
            </div>
        </div>

        <div class="btn-section-nav">
            <button class="btn btn-prev" onclick="backToStep1()">â† è¿”å›ç¬¬ä¸€æ­¥</button>
            <button class="btn btn-next" onclick="startCalculation()">ğŸš€ å¼€å§‹è®¡ç®—æ‰€æœ‰æ¢¯æ®µ</button>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—ç»“æœ -->
    <div id="step3" class="step-box">
        <h2>ğŸ“‹ ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—ç»“æœ</h2>
        <p style="color: var(--gray); margin-bottom: 25px;">ä»¥ä¸‹æ˜¯å„æ¢¯æ®µçš„è¯¦ç»†è®¡ç®—ç»“æœï¼Œç‚¹å‡»æ¯ä¸ªæ¢¯æ®µæŸ¥çœ‹å®Œæ•´V6.1è®¡ç®—ç»“æœ</p>
        
        <div id="resultArea">
            <div id="result">
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <h3>ç­‰å¾…è®¡ç®—...</h3>
                    <p>è¯·å…ˆé…ç½®æ¢¯æ®µç»“æ„å’Œå‚æ•°ï¼Œç„¶åç‚¹å‡»"å¼€å§‹è®¡ç®—"</p>
                </div>
            </div>
        </div>

        <div class="btn-section-nav">
            <button class="btn btn-prev" onclick="backToStep2()">â† è¿”å›å‚æ•°é…ç½®</button>
            <button class="btn" onclick="showSummaryReport()" style="background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%); color: white;">
                ğŸ“‹ æŸ¥çœ‹ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š
            </button>
        </div>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š -->
    <div id="step4" class="step-box">
        <h2>ğŸ“Š ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š</h2>
        <p style="color: var(--gray); margin-bottom: 25px;">æ‰€æœ‰æ¢¯æ®µåˆå¹¶åçš„éƒ¨ä»¶ç”¨é‡æ±‡æ€»</p>
        
        <div id="summaryArea">
            <div id="summaryResult">
                <!-- æ±‡æ€»å†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="btn-section-nav">
            <button class="btn btn-prev" onclick="backToStep3()">â† è¿”å›è¯¦ç»†ç»“æœ</button>
            <button class="btn" onclick="exportSummaryToExcel()" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); color: white;">
                ğŸ“Š å¯¼å‡ºExcelæ±‡æ€»æŠ¥å‘Š
            </button>
        </div>
    </div>
</div>

<script>
// ==================== å…¨å±€å˜é‡å’Œå¸¸é‡å®šä¹‰ ====================
let middleCount = 0;
let exitCount = 0;
let allSectionsData = []; // å­˜å‚¨æ‰€æœ‰æ¢¯æ®µæ•°æ®
let calculationResults = []; // å­˜å‚¨æ‰€æœ‰æ¢¯æ®µè®¡ç®—ç»“æœ
let summaryResults = {}; // æ±‡æ€»ç»“æœ
let globalCommonData = null; // å­˜å‚¨å…¬å…±å‚æ•°

// å®šä¹‰ä¸¤ç§æ¨¡å‹çš„è¾“å…¥æ¨¡æ¿
const inputTemplates = {
    circular_start: `
        <div class="input-group">
            <label>æ¥¼æ¢¯å¤–ç›´å¾„ (mm)</label>
            <input type="number" class="p-R" value="2600">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é•¿ (mm)</label>
            <input type="number" class="p-step-length" value="900">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥å®½ (ä¸­) (mm)</label>
            <input type="number" class="p-w" value="253.7">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é«˜ (mm)</label>
            <input type="number" class="p-h" value="190">
        </div>
        <div class="input-group">
            <label>è¸æ­¥æ•°é‡ (æ­¥)</label>
            <input type="number" class="p-steps" value="12">
        </div>
        <div class="input-group">
            <label>å¹³å°æ•°é‡</label>
            <input type="number" class="p-platforms" value="1">
        </div>
        <div class="input-group">
            <label>æ­¥å®½æ¯” (å¹³å°å®½/è¸æ­¥å®½)</label>
            <input type="number" class="p-width-ratio" value="3">
        </div>
        <div class="input-group">
            <label>èµ·æ­¥è½åœ°æ•°</label>
            <input type="number" class="p-start-landing" value="3">
        </div>
    `,
    circular_middle_exit: `
        <div class="input-group">
            <label>æ¥¼æ¢¯å¤–ç›´å¾„ (mm)</label>
            <input type="number" class="p-R" value="2600">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é•¿ (mm)</label>
            <input type="number" class="p-step-length" value="900">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥å®½ (ä¸­) (mm)</label>
            <input type="number" class="p-w" value="253.7">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é«˜ (mm)</label>
            <input type="number" class="p-h" value="190">
        </div>
        <div class="input-group">
            <label>è¸æ­¥æ•°é‡ (æ­¥)</label>
            <input type="number" class="p-steps" value="12">
        </div>
        <div class="input-group">
            <label>å¹³å°æ•°é‡</label>
            <input type="number" class="p-platforms" value="1">
        </div>
        <div class="input-group">
            <label>æ­¥å®½æ¯” (å¹³å°å®½/è¸æ­¥å®½)</label>
            <input type="number" class="p-width-ratio" value="3">
        </div>
    `,
    straight_start: `
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é•¿ (mm)</label>
            <input type="number" class="p-step-length" value="1200">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥å®½ (mm)</label>
            <input type="number" class="p-w" value="280">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é«˜ (mm)</label>
            <input type="number" class="p-h" value="180">
        </div>
        <div class="input-group">
            <label>è¸æ­¥æ•°é‡ (æ­¥)</label>
            <input type="number" class="p-steps" value="15">
        </div>
        <div class="input-group">
            <label>å¹³å°æ•°é‡</label>
            <input type="number" class="p-platforms" value="1">
        </div>
        <div class="input-group">
            <label>æ­¥å®½æ¯” (å¹³å°å®½/è¸æ­¥å®½)</label>
            <input type="number" class="p-width-ratio" value="1.5">
        </div>
        <div class="input-group">
            <label>èµ·æ­¥è½åœ°æ•°</label>
            <input type="number" class="p-start-landing" value="3">
        </div>
    `,
    straight_middle_exit: `
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é•¿ (mm)</label>
            <input type="number" class="p-step-length" value="1200">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥å®½ (mm)</label>
            <input type="number" class="p-w" value="280">
        </div>
        <div class="input-group">
            <label>æ¥¼æ¢¯æ­¥é«˜ (mm)</label>
            <input type="number" class="p-h" value="180">
        </div>
        <div class="input-group">
            <label>è¸æ­¥æ•°é‡ (æ­¥)</label>
            <input type="number" class="p-steps" value="15">
        </div>
        <div class="input-group">
            <label>å¹³å°æ•°é‡</label>
            <input type="number" class="p-platforms" value="1">
        </div>
        <div class="input-group">
            <label>æ­¥å®½æ¯” (å¹³å°å®½/è¸æ­¥å®½)</label>
            <input type="number" class="p-width-ratio" value="1.5">
        </div>
    `
};

// é»˜è®¤å¸¸é‡å®šä¹‰
const DEFAULT_CONSTANTS = {
    materialDensity: 7850, weldAllowance: 1.05, safeFactor: 1.20, hanging: 130, foldingEdge: 25, 
    embedMargin: 60, finishThickness: 50, bottomKeel: 40, singlePlateHeight: 1050, 
    glassSlotHeight: 100, boxThickness: 40, exitEmbedWidth: 500
};

// é»˜è®¤åšåº¦å€¼
const DEFAULT_THICKNESSES = {
    // é¢„åŸ‹æ¿éƒ¨åˆ†
    embedStart: 12, embedExit: 12, embedExitFlat: 12, 
    // èµ·æ­¥éƒ¨åˆ†
    startTread: 5, startRiser: 8, startRib: 8, 
    // è¸æ­¥éƒ¨åˆ†
    treadFold: 5, treadRib: 8, 
    // å¹³å°éƒ¨åˆ†
    platformFold: 5, platformRib: 8, 
    // å°åº•éƒ¨åˆ†
    bottomPlate: 3, 
    // å†…ä¾§æ¢éƒ¨åˆ†
    innerPlate: 10, innerBoxOuter: 10, innerBoxCover: 5, innerBoxRib: 8, 
    // å¤–ä¾§æ¢éƒ¨åˆ†
    outerPlate: 10, outerBoxOuter: 10, outerBoxCover: 5, outerBoxRib: 8
};

// åšåº¦é¢„è®¾é…ç½®
const THICKNESS_PROFILES = {
    'standard': DEFAULT_THICKNESSES, // é»˜è®¤å€¼
    'economical': {
        embedStart: 10, embedExit: 10, embedExitFlat: 10,
        startTread: 4, startRiser: 6, startRib: 6,
        treadFold: 4, treadRib: 6,
        platformFold: 4, platformRib: 6,
        bottomPlate: 2,
        innerPlate: 8, innerBoxOuter: 8, innerBoxCover: 4, innerBoxRib: 6,
        outerPlate: 8, outerBoxOuter: 8, outerBoxCover: 4, outerBoxRib: 6
    },
    'heavy-duty': {
        embedStart: 16, embedExit: 16, embedExitFlat: 16,
        startTread: 6, startRiser: 10, startRib: 10,
        treadFold: 6, treadRib: 10,
        platformFold: 6, platformRib: 10,
        bottomPlate: 4,
        innerPlate: 12, innerBoxOuter: 12, innerBoxCover: 6, innerBoxRib: 10,
        outerPlate: 12, outerBoxOuter: 12, outerBoxCover: 6, outerBoxRib: 10
    }
};

// ==================== æ’åºå‡½æ•° ====================
// æŒ‰æ¢¯æ®µç±»å‹æ’åºï¼šèµ·æ­¥æ®µ â†’ ä¸­é—´æ®µ â†’ å‡ºå£æ®µ
function sortSectionsByType(sections) {
    // å…ˆæŒ‰ç±»å‹æ’åºï¼šstart(1) â†’ middle(2) â†’ exit(3)
    // å¦‚æœéƒ½æ˜¯ä¸­é—´æ®µï¼Œå†æŒ‰æ·»åŠ é¡ºåºæ’åº
    return [...sections].sort((a, b) => {
        const typeOrder = { 'start': 1, 'middle': 2, 'exit': 3 };
        
        // é¦–å…ˆæŒ‰ç±»å‹æ’åº
        if (typeOrder[a.sectionType] !== typeOrder[b.sectionType]) {
            return typeOrder[a.sectionType] - typeOrder[b.sectionType];
        }
        
        // å¦‚æœç±»å‹ç›¸åŒï¼ˆéƒ½æ˜¯middleï¼‰ï¼ŒæŒ‰åŸå§‹ç´¢å¼•æ’åº
        return a.index - b.index;
    });
}

// è·å–å½“å‰æ‰€æœ‰æ¢¯æ®µçš„é€»è¾‘é¡ºåº
function getCurrentLogicOrder() {
    const cards = document.querySelectorAll('.struct-card');
    const sections = Array.from(cards).map((card, index) => ({
        element: card,
        id: card.id,
        sectionType: card.classList.contains('struct-start') ? 'start' : 
                    card.classList.contains('struct-middle') ? 'middle' : 'exit',
        title: card.querySelector('strong')?.innerText || `æ¢¯æ®µ ${index + 1}`
    }));
    
    return sortSectionsByType(sections);
}

// æ›´æ–°é…ç½®ç•Œé¢çš„é€»è¾‘é¡ºåºæ˜¾ç¤º
function updateLogicOrderDisplay() {
    const sortedSections = getCurrentLogicOrder();
    
    sortedSections.forEach((section, index) => {
        const orderBadge = section.element.querySelector('.logic-order');
        if (orderBadge) {
            orderBadge.textContent = index + 1;
        } else {
            // æ·»åŠ é¡ºåºæ ‡è®°
            const badge = document.createElement('div');
            badge.className = 'logic-order';
            badge.textContent = index + 1;
            section.element.appendChild(badge);
        }
    });
}

// ==================== åˆå§‹åŒ–å‡½æ•° ====================
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–å¤šæ¢¯æ®µé…ç½®
    initMultiSectionConfig();
    
    // åˆå§‹åŒ–åšåº¦è¾“å…¥åŒºåŸŸ
    initThicknessInputs();
    
    // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
    updateStepIndicator(1);
});

// åˆå§‹åŒ–å¤šæ¢¯æ®µé…ç½®
function initMultiSectionConfig() {
    const structureList = document.getElementById('structure-list');
    structureList.innerHTML = '';
    
    // æ·»åŠ èµ·æ­¥æ®µ
    const startCardHtml = `
        <div class="struct-card struct-start" id="card_start">
            <div class="logic-order">1</div>
            <div class="card-header">
                <span><strong>ğŸ“ èµ·æ­¥æ®µ</strong> (å¿…é¡»é…ç½®)</span>
                <select class="model-select" onchange="updateCardUI('card_start', this.value)">
                    <option value="circular" selected>æ­£åœ†æ¨¡å‹</option>
                    <option value="straight">ç›´æ¢¯æ¨¡å‹</option>
                </select>
            </div>
            <div class="param-inner-grid" id="body_card_start">
                ${inputTemplates.circular_start}
            </div>
        </div>
    `;
    
    structureList.innerHTML = startCardHtml;
    
    // é‡ç½®è®¡æ•°
    middleCount = 0;
    exitCount = 0;
    allSectionsData = [];
}

// åˆå§‹åŒ–åšåº¦è¾“å…¥åŒºåŸŸ
function initThicknessInputs() {
    const thicknessInputsContainer = document.getElementById('thicknessInputsContainer');
    if (!thicknessInputsContainer) return;
    
    const thicknessGroups = [
        {
            title: "é¢„åŸ‹æ¿éƒ¨åˆ†",
            category: "embed-category",
            inputs: [
                { id: "embedStart", label: "èµ·æ­¥é¢„åŸ‹æ¿", value: 12, min: 8, max: 20, step: 1, hint: "å»ºè®®: 12-16mm" },
                { id: "embedExit", label: "å‡ºå£é¢„åŸ‹æ¿", value: 12, min: 8, max: 20, step: 1, hint: "å»ºè®®: 12-16mm" },
                { id: "embedExitFlat", label: "å‡ºå£æ°´å¹³é¢„åŸ‹æ¿", value: 12, min: 8, max: 20, step: 1, hint: "å»ºè®®: 12-16mm" }
            ]
        },
        {
            title: "èµ·æ­¥éƒ¨åˆ†",
            category: "start-category",
            inputs: [
                { id: "startTread", label: "èµ·æ­¥è¸æ¿", value: 5, min: 3, max: 8, step: 0.5, hint: "å»ºè®®: 4-6mm" },
                { id: "startRiser", label: "èµ·æ­¥ç«‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" },
                { id: "startRib", label: "èµ·æ­¥ç­‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" }
            ]
        },
        {
            title: "è¸æ­¥éƒ¨åˆ†",
            category: "tread-category",
            inputs: [
                { id: "treadFold", label: "è¸æ­¥æŠ˜æ¿", value: 5, min: 3, max: 8, step: 0.5, hint: "å»ºè®®: 4-6mm" },
                { id: "treadRib", label: "è¸æ­¥ç­‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" }
            ]
        },
        {
            title: "å¹³å°éƒ¨åˆ†",
            category: "platform-category",
            inputs: [
                { id: "platformFold", label: "å¹³å°æŠ˜æ¿", value: 5, min: 3, max: 8, step: 0.5, hint: "å»ºè®®: 4-6mm" },
                { id: "platformRib", label: "å¹³å°ç­‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" }
            ]
        },
        {
            title: "å°åº•éƒ¨åˆ†",
            category: "bottom-category",
            inputs: [
                { id: "bottomPlate", label: "åº•æ¿", value: 3, min: 2, max: 6, step: 0.5, hint: "å»ºè®®: 2-4mm" }
            ]
        },
        {
            title: "å†…ä¾§æ¢éƒ¨åˆ†",
            category: "sidebeam-category",
            inputs: [
                { id: "innerPlate", label: "å†…ä¾§æ¿", value: 10, min: 8, max: 16, step: 1, hint: "å»ºè®®: 8-12mm" },
                { id: "innerBoxOuter", label: "å†…ä¾§ç®±æ¢å¤–", value: 10, min: 8, max: 16, step: 1, hint: "å»ºè®®: 8-12mm" },
                { id: "innerBoxCover", label: "å†…ä¾§ç®±æ¢ç›–æ¿", value: 5, min: 4, max: 8, step: 0.5, hint: "å»ºè®®: 4-6mm" },
                { id: "innerBoxRib", label: "å†…ä¾§ç®±æ¢ç­‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" }
            ]
        },
        {
            title: "å¤–ä¾§æ¢éƒ¨åˆ†",
            category: "sidebeam-category",
            inputs: [
                { id: "outerPlate", label: "å¤–ä¾§æ¿", value: 10, min: 8, max: 16, step: 1, hint: "å»ºè®®: 8-12mm" },
                { id: "outerBoxOuter", label: "å¤–ä¾§ç®±æ¢å¤–", value: 10, min: 8, max: 16, step: 1, hint: "å»ºè®®: 8-12mm" },
                { id: "outerBoxCover", label: "å¤–ä¾§ç®±æ¢ç›–æ¿", value: 5, min: 4, max: 8, step: 0.5, hint: "å»ºè®®: 4-6mm" },
                { id: "outerBoxRib", label: "å¤–ä¾§ç®±æ¢ç­‹æ¿", value: 8, min: 6, max: 12, step: 1, hint: "å»ºè®®: 6-10mm" }
            ]
        }
    ];
    
    let html = '';
    thicknessGroups.forEach(group => {
        html += `
            <div class="thickness-category ${group.category}">
                <h3>${group.title}</h3>
                <div class="thickness-grid">
                    ${group.inputs.map(input => `
                        <div class="thickness-item">
                            <label for="${input.id}">${input.label}</label>
                            <div class="thickness-input-group">
                                <input type="number" id="${input.id}" 
                                       value="${input.value}" 
                                       min="${input.min}" 
                                       max="${input.max}" 
                                       step="${input.step}">
                                <span class="thickness-unit">mm</span>
                            </div>
                            <div class="thickness-hint">${input.hint}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    thicknessInputsContainer.innerHTML = html;
}

// ==================== å¤šæ¢¯æ®µé…ç½®åŠŸèƒ½ ====================
// æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
function updateStepIndicator(step) {
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById('step-indicator-' + i);
        if (indicator) {
            indicator.classList.remove('active', 'completed');
            if (i === step) {
                indicator.classList.add('active');
            } else if (i < step) {
                indicator.classList.add('completed');
            }
        }
    }
    
    // æ˜¾ç¤ºå¯¹åº”æ­¥éª¤
    document.querySelectorAll('.step-box').forEach(box => {
        box.classList.remove('step-active');
    });
    document.getElementById('step' + step).classList.add('step-active');
}

// åˆ‡æ¢å¡ç‰‡å†…éƒ¨çš„è¾“å…¥é¡¹
function updateCardUI(cardId, modelType) {
    const body = document.getElementById('body_' + cardId);
    const card = document.getElementById(cardId);
    if (!body || !card) return;
    
    const isStart = card.classList.contains('struct-start');
    const isMiddle = card.classList.contains('struct-middle');
    const isExit = card.classList.contains('struct-exit');
    
    if (modelType === 'circular') {
        if (isStart) {
            body.innerHTML = inputTemplates.circular_start;
        } else {
            body.innerHTML = inputTemplates.circular_middle_exit;
        }
    } else {
        if (isStart) {
            body.innerHTML = inputTemplates.straight_start;
        } else {
            body.innerHTML = inputTemplates.straight_middle_exit;
        }
    }
}

// æ·»åŠ æ–°æ®µè½ - å¢åŠ æ™ºèƒ½æç¤º
function addNewSection(type) {
    let countLimit = type === 'middle' ? 5 : 2;
    let currentCount = type === 'middle' ? middleCount : exitCount;
    
    if (currentCount >= countLimit) {
        alert(`æœ€å¤šæ·»åŠ  ${countLimit} æ®µ${type === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ'}`);
        return;
    }

    // æ£€æŸ¥å½“å‰é…ç½®æƒ…å†µï¼Œç»™äºˆæ™ºèƒ½æç¤º
    const currentSections = document.querySelectorAll('.struct-card');
    const hasStart = Array.from(currentSections).some(card => 
        card.classList.contains('struct-start')
    );
    
    // ç‰¹æ®Šæ£€æŸ¥ï¼šæ·»åŠ å‡ºå£æ®µæ—¶çš„æç¤º
    if (type === 'exit') {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å‡ºå£æ®µ
        const hasExit = Array.from(currentSections).some(card => 
            card.classList.contains('struct-exit')
        );
        
        if (hasExit) {
            alert('åªèƒ½æ·»åŠ ä¸€ä¸ªå‡ºå£æ®µï¼');
            return;
        }
        
        // æç¤ºé€»è¾‘é¡ºåº
        if (!hasStart) {
            const confirmAdd = confirm('æç¤ºï¼šé€šå¸¸æ¥¼æ¢¯ç»“æ„ä»èµ·æ­¥æ®µå¼€å§‹ã€‚\n\nå»ºè®®é…ç½®é¡ºåºï¼šèµ·æ­¥æ®µ â†’ ä¸­é—´æ®µ â†’ å‡ºå£æ®µ\n\næ˜¯å¦ç»§ç»­æ·»åŠ å‡ºå£æ®µï¼Ÿ');
            if (!confirmAdd) return;
        }
        
        // å¦‚æœæœ‰å¤šä¸ªä¸­é—´æ®µï¼Œç¡®è®¤å‡ºå£æ®µä½ç½®
        if (middleCount > 0) {
            const confirmAdd = confirm('æç¤ºï¼šæ‚¨å·²ç»é…ç½®äº†ä¸­é—´æ®µã€‚\n\nå‡ºå£æ®µé€šå¸¸ä½äºæ‰€æœ‰ä¸­é—´æ®µä¹‹åã€‚\n\nç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰é€»è¾‘é¡ºåºæ’åºæ˜¾ç¤ºã€‚\n\næ˜¯å¦ç»§ç»­æ·»åŠ å‡ºå£æ®µï¼Ÿ');
            if (!confirmAdd) return;
        }
    }
    
    // å¢åŠ è®¡æ•°
    if (type === 'middle') middleCount++; else exitCount++;
    
    const id = 'card_' + Math.random().toString(36).substr(2, 9);
    const container = document.getElementById('structure-list');
    const title = type === 'middle' ? `ä¸­é—´æ®µ ${middleCount}` : `å‡ºå£æ®µ ${exitCount}`;
    const cssClass = type === 'middle' ? 'struct-middle' : 'struct-exit';

    const html = `
        <div class="struct-card ${cssClass}" id="${id}">
            <div class="logic-order"></div>
            <div class="card-header">
                <span><strong>ğŸ“ ${title}</strong></span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select class="model-select" onchange="updateCardUI('${id}', this.value)">
                        <option value="circular" selected>æ­£åœ†æ¨¡å‹</option>
                        <option value="straight">ç›´æ¢¯æ¨¡å‹</option>
                    </select>
                    <button onclick="removeSection('${id}', '${type}')" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold; font-size: 16px;">âœ•</button>
                </div>
            </div>
            <div class="param-inner-grid" id="body_${id}">
                ${inputTemplates.circular_middle_exit}
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    
    // æ›´æ–°é€»è¾‘é¡ºåºæ˜¾ç¤º
    updateLogicOrderDisplay();
}

// åˆ é™¤æ¢¯æ®µ
function removeSection(id, type) {
    const element = document.getElementById(id);
    if (element) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¢¯æ®µå—ï¼Ÿ')) {
            element.remove();
            if (type === 'middle') middleCount--; else exitCount--;
            
            // æ›´æ–°é€»è¾‘é¡ºåºæ˜¾ç¤º
            updateLogicOrderDisplay();
        }
    }
}

// ==================== æ­¥éª¤å¯¼èˆªåŠŸèƒ½ ====================
// è·³è½¬åˆ°ç¬¬äºŒæ­¥
function goToStep2() {
    // æ”¶é›†ç¬¬ä¸€æ­¥æ•°æ®
    if (!collectStep1Data()) {
        alert("è¯·è‡³å°‘é…ç½®èµ·æ­¥æ®µ");
        return;
    }
    
    // æ˜¾ç¤ºé€»è¾‘é¡ºåºç¡®è®¤
    const sortedSections = sortSectionsByType(allSectionsData);
    let orderMessage = "ğŸ“‹ å½“å‰æ¢¯æ®µé…ç½®ï¼ˆæŒ‰é€»è¾‘é¡ºåºæ’åˆ—ï¼‰ï¼š\n\n";
    
    sortedSections.forEach((section, index) => {
        const typeName = section.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : 
                        section.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ';
        orderMessage += `${index + 1}. ${typeName} - ${section.title}\n`;
    });
    
    orderMessage += "\nç³»ç»Ÿå°†æŒ‰æ­¤é¡ºåºè¿›è¡Œè®¡ç®—å’Œæ˜¾ç¤ºã€‚";
    
    alert(orderMessage);
    
    updateStepIndicator(2);
}

// æ”¶é›†ç¬¬ä¸€æ­¥æ•°æ® - ä¿®æ­£ï¼šä¸­é—´æ®µå’Œå‡ºå£æ®µä¸æ”¶é›†èµ·æ­¥è½åœ°æ•°
function collectStep1Data() {
    allSectionsData = [];
    const stages = document.querySelectorAll('.struct-card');
    
    if (stages.length === 0) {
        return false;
    }
    
    stages.forEach((card, index) => {
        const title = card.querySelector('strong')?.innerText || `æ¢¯æ®µ ${index + 1}`;
        const modelSelect = card.querySelector('.model-select');
        const modelType = modelSelect?.value || 'circular';
        const modelName = modelType === 'straight' ? 'ç›´æ¢¯æ¨¡å‹' : 'æ­£åœ†æ¨¡å‹';
        
        // åˆ¤æ–­æ¢¯æ®µç±»å‹
        let sectionType = 'start'; // é»˜è®¤å€¼
        if (card.classList.contains('struct-start')) {
            sectionType = 'start';
        } else if (card.classList.contains('struct-middle')) {
            sectionType = 'middle';
        } else if (card.classList.contains('struct-exit')) {
            sectionType = 'exit';
        }
        
        // æ”¶é›†å‚æ•°å€¼ - ä¿®æ­£ï¼šä¸­é—´æ®µå’Œå‡ºå£æ®µä¸æ”¶é›†èµ·æ­¥è½åœ°æ•°
        const params = {};
        const inputs = card.querySelectorAll('input');
        inputs.forEach(input => {
            // å¯¹äºéèµ·æ­¥æ®µï¼Œè·³è¿‡èµ·æ­¥è½åœ°æ•°
            if (sectionType !== 'start' && input.classList.contains('p-start-landing')) {
                return; // è·³è¿‡è¿™ä¸ªè¾“å…¥
            }
            
            // è·å–å‚æ•°ç±»åˆ«
            if (input.classList.contains('p-R')) params['p-R'] = parseFloat(input.value) || 0;
            else if (input.classList.contains('p-step-length')) params['p-step-length'] = parseFloat(input.value) || 0;
            else if (input.classList.contains('p-w')) params['p-w'] = parseFloat(input.value) || 0;
            else if (input.classList.contains('p-h')) params['p-h'] = parseFloat(input.value) || 0;
            else if (input.classList.contains('p-steps')) params['p-steps'] = parseInt(input.value) || 0;
            else if (input.classList.contains('p-platforms')) params['p-platforms'] = parseInt(input.value) || 0;
            else if (input.classList.contains('p-width-ratio')) params['p-width-ratio'] = parseFloat(input.value) || 0;
            else if (input.classList.contains('p-start-landing')) params['p-start-landing'] = parseInt(input.value) || 0;
        });
        
        // å¯¹äºéèµ·æ­¥æ®µï¼Œç¡®ä¿èµ·æ­¥è½åœ°æ•°ä¸º0
        if (sectionType !== 'start') {
            params['p-start-landing'] = 0;
        }
        
        allSectionsData.push({
            id: card.id,
            index: index,
            title: title,
            modelType: modelType,
            modelName: modelName,
            sectionType: sectionType, // æ­£ç¡®ä¼ é€’æ¢¯æ®µç±»å‹
            params: params
        });
    });
    
    console.log("æ”¶é›†åˆ°çš„æ¢¯æ®µæ•°æ®:", allSectionsData);
    return true;
}

// è¿”å›ç¬¬ä¸€æ­¥
function backToStep1() {
    updateStepIndicator(1);
}

// è¿”å›ç¬¬äºŒæ­¥
function backToStep2() {
    updateStepIndicator(2);
}

// è¿”å›ç¬¬ä¸‰æ­¥
function backToStep3() {
    updateStepIndicator(3);
}

// ==================== å‚æ•°é…ç½®åŠŸèƒ½ ====================
// æ§åˆ¶å‡½æ•°ï¼šåˆ‡æ¢æ˜¾ç¤º/éšè—è¾“å…¥åŒºåŸŸ
function switchMode(mode, areaId) {
    const area = document.getElementById(areaId);
    if (areaId === 'thicknessInputArea') {
        area.style.display = (mode === 'custom') ? 'block' : 'none';
    } else if (areaId === 'constantsInputArea') {
        area.style.display = (mode === 'custom') ? 'flex' : 'none';
    }
}

// åº”ç”¨åšåº¦é¢„è®¾
function applyThicknessProfile(profile) {
    const thicknesses = THICKNESS_PROFILES[profile];
    if (!thicknesses) return;
    
    for (const [key, value] of Object.entries(thicknesses)) {
        const input = document.getElementById(key);
        if (input) {
            input.value = value;
        }
    }
    
    // æ›´æ–°å¿«é€Ÿè®¾ç½®æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.quick-setting-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// é‡ç½®ä¸ºé»˜è®¤åšåº¦
function resetThicknessToDefault() {
    applyThicknessProfile('standard');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.quick-setting-btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// ==================== V6.1å®Œæ•´è®¡ç®—å‡½æ•° - å·²ä¿®æ­£é¢„åŸ‹æ¿æ•°é‡å’Œèµ·æ­¥éƒ¨ä»¶é€»è¾‘ ====================
// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å•ä½å®šé¢é¢ç§¯å’Œé‡é‡ - ä»V6.1å¤åˆ¶
function calculateUnitMetrics(length, width, thickness, density) {
    // è½¬åŒ–ä¸ºç±³
    const L_m = length / 1000;
    const W_m = width / 1000;
    const T_m = thickness / 1000;
    
    // é¢ç§¯ (mÂ²) = é•¿ * å®½
    const area = L_m * W_m; 
    
    // é‡é‡ (kg) = é¢ç§¯ * åšåº¦ (m) * å¯†åº¦ (kg/mÂ³)
    const weight = area * T_m * density;

    return { area: area, weight: weight };
}

// V6.1ä¸»è®¡ç®—å‡½æ•° - ä¿®æ­£äº†é¢„åŸ‹æ¿æ•°é‡é€»è¾‘å’Œèµ·æ­¥éƒ¨ä»¶é€»è¾‘
function calculateV6(data, commonData) {
    const PI = Math.PI;
    
    // è§£æ„å‚æ•° - å®Œå…¨æŒ‰ç…§V6.1çš„æ ¼å¼
    const {
        shape,
        outerDiameter = 0,
        stepLength, stepWidth, stepHeight, stepCount, platformCount,
        widthRatio, landingSteps
    } = data;
    
    const {
        constants,
        outerHandrail, innerHandrail, exitLevel,
        thicknesses,
        sectionType = 'start', // æ¢¯æ®µç±»å‹
        isLastMiddleWithoutExit = false, // æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªä¸­é—´æ®µä¸”æ²¡æœ‰å‡ºå£æ®µ
        isOnlySection = false // æ˜¯å¦æ˜¯å”¯ä¸€æ¢¯æ®µ
    } = commonData;
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºèµ·æ­¥æ®µ
    const isStartSection = (sectionType === 'start');
    
    // ä¿®æ­£ï¼šåªæœ‰èµ·æ­¥æ®µæ‰ä½¿ç”¨ landingStepsï¼Œå…¶ä»–æ®µä¸º 0
    const effectiveLandingSteps = isStartSection ? landingSteps : 0;
    
    // ç­‹æ¿æ•°é‡ - å®Œå…¨æŒ‰ç…§V6.1å…¬å¼
    const ribCount = (stepLength > 0) ? Math.ceil(stepLength / 350 - 1) : 0; 
    
    // æ ¹æ®å½¢çŠ¶è¿›è¡Œä¸åŒçš„è®¡ç®— - å®Œå…¨æŒ‰ç…§V6.1é€»è¾‘
    let innerDiameter, middleDiameter, stepAngle, innerStepWidth, outerStepWidth;
    
    if (shape === 'circular') {
        // æ­£åœ†èºæ—‹æ¢¯è®¡ç®— - å®Œå…¨æŒ‰ç…§V6.1
        // ç›´å¾„ï¼ˆå†…ï¼‰
        innerDiameter = outerDiameter - (stepLength * 2);
        // ç›´å¾„ï¼ˆä¸­ï¼‰
        middleDiameter = stepLength + innerDiameter; 
        
        // è¸æ­¥èºæ—‹è§’åº¦ 
        stepAngle = 0;
        if (middleDiameter > 0) {
            let ratio = stepWidth / middleDiameter;
            const safeRatio = Math.min(Math.max(ratio, -1), 1); 
            const stepAngle_val = Math.asin(safeRatio) * (180 / PI) * 2;
            stepAngle = Math.round(stepAngle_val * 1000) / 1000;
        }

        const innerFactor = stepAngle / 360; 
        
        // æ­¥å®½ï¼ˆå†…ï¼‰
        innerStepWidth = innerFactor * innerDiameter * PI;
        // æ­¥å®½ï¼ˆå¤–ï¼‰
        outerStepWidth = innerFactor * outerDiameter * PI;
        
    } else if (shape === 'straight') {
        // ç›´è·‘æ¢¯è®¡ç®—é€»è¾‘ - å®Œå…¨æŒ‰ç…§V6.1
        innerDiameter = 0;
        middleDiameter = 0;
        stepAngle = 0;
        innerStepWidth = stepWidth; // ç›´è·‘æ¢¯æ­¥å®½å›ºå®š
        outerStepWidth = stepWidth; // ç›´è·‘æ¢¯æ­¥å®½å›ºå®š
    }
    
    // æ¥¼æ¢¯èºæ—‹è§’åº¦
    const totalEquivalentSteps = stepCount + (platformCount * widthRatio) - platformCount;
    const stairAngle = stepAngle * totalEquivalentSteps;
    // å±‚é«˜
    const floorHeight = stepCount * stepHeight;
    
    // å¡åº¦è®¡ç®—éƒ¨åˆ† - å®Œå…¨æŒ‰ç…§V6.1
    const platformHeightEquiv = (widthRatio > 0) ? stepHeight / widthRatio : 0; // å¹³å°ç­‰æ•ˆæ­¥é«˜
    
    // å¡åº¦è®¡ç®—
    const slope1_numerator = Math.sqrt((innerStepWidth * innerStepWidth) + (stepHeight * stepHeight));
    const slope1_InnerTreadInnerSlope = (innerStepWidth > 0) ? slope1_numerator / innerStepWidth : 0; 

    const slope2_numerator = (outerStepWidth * outerStepWidth) + (stepHeight * stepHeight);
    const slope2_OuterTreadInnerSlope = (outerStepWidth > 0) ? Math.sqrt(slope2_numerator) / outerStepWidth : 0; 

    const slope3_numerator = (innerStepWidth * innerStepWidth) + (platformHeightEquiv * platformHeightEquiv);
    const slope3_InnerPlatformInnerSlope = (innerStepWidth > 0) ? Math.sqrt(slope3_numerator) / innerStepWidth : 0; 

    const slope4_numerator = (outerStepWidth * outerStepWidth) + (platformHeightEquiv * platformHeightEquiv);
    const slope4_OuterPlatformInnerSlope = (outerStepWidth > 0) ? Math.sqrt(slope4_numerator) / outerStepWidth : 0; 

    // è¸æ­¥æ–œç‡è®¡ç®—
    const stepSlope = stepHeight / Math.sqrt(stepWidth * stepWidth + stepHeight * stepHeight);
    const inclineAngle = Math.asin(stepSlope) * (180 / PI);

    // ç”¨æ–™è®¡ç®—éƒ¨åˆ†ï¼šå¸¸é‡å’ŒåŸºç¡€å˜é‡ - å®Œå…¨æŒ‰ç…§V6.1
    const materialDensity = constants.materialDensity;
    const embedMargin = constants.embedMargin;
    
    // ä¿®æ­£ï¼šä½¿ç”¨ effectiveLandingSteps è€Œä¸æ˜¯ landingSteps
    const totalTreadCount = stepCount - effectiveLandingSteps - platformCount;
    const platformCountEquiv = platformCount * widthRatio; // å¹³å°ç­‰æ•ˆæ•°é‡ (ç”¨äºå¹³å°æ¿è®¡ç®—)
    
    // ========== ä¿®æ­£é¢„åŸ‹æ¿æ•°é‡è®¡ç®—éƒ¨åˆ† ==========
    // E1: èµ·æ­¥é¢„åŸ‹æ¿ - åªæœ‰èµ·æ­¥æ®µæ‰éœ€è¦ï¼Œæ•°é‡ä¸º1
    const E1_Length = stepLength + 2 * embedMargin; 
    const E1_Width_Term1 = (shape === 'straight') ? effectiveLandingSteps * stepWidth : (stepAngle / 360) * effectiveLandingSteps * middleDiameter * PI;
    const E1_Width = E1_Width_Term1 + (embedMargin * 2) + 100;
    const E1_Thickness = thicknesses.embedStart; 
    
    // ä¿®æ­£ï¼šåªæœ‰sectionTypeä¸º'start'æ—¶æ‰ä¸º1ï¼Œå…¶ä»–éƒ½ä¸º0
    const E1_Count = (sectionType === 'start') ? 1 : 0;

    // E2: å‡ºå£é¢„åŸ‹æ¿ - æ ¹æ®æ¢¯æ®µç±»å‹å’Œé…ç½®å†³å®š
    const E2_Length = stepLength + 2 * embedMargin;
    let E2_Width_Add = (exitLevel === 'no') ? stepHeight : 0; 
    const E2_Width = constants.exitEmbedWidth + E2_Width_Add; 
    const E2_Thickness = thicknesses.embedExit;
    
    let E2_Count = 0;
    if (sectionType === 'exit') {
        E2_Count = 1; // å‡ºå£æ®µå§‹ç»ˆä¸º1
    } else if (sectionType === 'middle' && isLastMiddleWithoutExit) {
        E2_Count = 1; // æœ€åä¸€ä¸ªä¸­é—´æ®µä¸”æ²¡æœ‰å‡ºå£æ®µæ—¶ä¸º1
    } else if (sectionType === 'start' && isOnlySection) {
        E2_Count = 1; // èµ·æ­¥æ®µä¸”æ˜¯å”¯ä¸€æ¢¯æ®µæ—¶ä¸º1
    }
    
    // E3: å‡ºå£æ°´å¹³é¢„åŸ‹æ¿ - æ•°é‡ä¸å‡ºå£é¢„åŸ‹æ¿ä¸€è‡´
    const E3_Length = stepLength + 2 * embedMargin;
    const E3_Width = 240.00; 
    const E3_Thickness = thicknesses.embedExitFlat;
    const E3_Count = E2_Count; // è·Ÿéšå‡ºå£é¢„åŸ‹æ¿æ•°é‡
    
    const E1_UnitMetrics = calculateUnitMetrics(E1_Length, E1_Width, E1_Thickness, materialDensity);
    const E1_TotalArea = E1_UnitMetrics.area * E1_Count;
    const E1_TotalWeight = E1_UnitMetrics.weight * E1_Count;

    const E2_UnitMetrics = calculateUnitMetrics(E2_Length, E2_Width, E2_Thickness, materialDensity);
    const E2_TotalArea = E2_UnitMetrics.area * E2_Count;
    const E2_TotalWeight = E2_UnitMetrics.weight * E2_Count;

    const E3_UnitMetrics = calculateUnitMetrics(E3_Length, E3_Width, E3_Thickness, materialDensity);
    const E3_TotalArea = E3_UnitMetrics.area * E3_Count;
    const E3_TotalWeight = E3_UnitMetrics.weight * E3_Count;
    
    // ç”¨æ–™è®¡ç®—éƒ¨åˆ†ï¼šèµ·æ­¥ (ST/SR/SRib) - åªåœ¨èµ·æ­¥æ®µè®¡ç®—
    const START_RISER_WIDTH = 477.5; 
    const START_RIB_WIDTH = 430.0;   

    // ST: èµ·æ­¥è¸æ¿ - åªåœ¨èµ·æ­¥æ®µæœ‰
    const ST_Length = stepLength;       
    const ST_Width = stepWidth;         
    const ST_Thickness = thicknesses.startTread;    
    const ST_Count = effectiveLandingSteps; // ä¿®æ­£ï¼šåªåœ¨èµ·æ­¥æ®µæœ‰æ•°é‡
    const ST_UnitMetrics = calculateUnitMetrics(ST_Length, ST_Width, ST_Thickness, materialDensity);
    const ST_TotalArea = ST_UnitMetrics.area * ST_Count;
    const ST_TotalWeight = ST_UnitMetrics.weight * ST_Count;

    // SR: èµ·æ­¥ç«‹æ¿ - åªåœ¨èµ·æ­¥æ®µæœ‰
    const SR_Length = stepLength;       
    const SR_Width = START_RISER_WIDTH;      
    const SR_Thickness = thicknesses.startRiser;    
    const SR_Count = effectiveLandingSteps + (isStartSection ? 1 : 0); // +1 åªåœ¨èµ·æ­¥æ®µ
    const SR_UnitMetrics = calculateUnitMetrics(SR_Length, SR_Width, SR_Thickness, materialDensity);
    const SR_TotalArea = SR_UnitMetrics.area * SR_Count;
    const SR_TotalWeight = SR_UnitMetrics.weight * SR_Count;

    // SRib: èµ·æ­¥ç­‹æ¿ - åªåœ¨èµ·æ­¥æ®µæœ‰
    const SRib_Length = stepWidth;      
    const SRib_Width = START_RIB_WIDTH;      
    const SRib_Thickness = thicknesses.startRib;    
    const SRib_Count = ribCount * effectiveLandingSteps; // ä¿®æ­£ï¼šåªåœ¨èµ·æ­¥æ®µè®¡ç®—
    const SRib_UnitMetrics = calculateUnitMetrics(SRib_Length, SRib_Width, SRib_Thickness, materialDensity);
    const SRib_TotalArea = SRib_UnitMetrics.area * SRib_Count;
    const SRib_TotalWeight = SRib_UnitMetrics.weight * SRib_Count;
    
    // ç”¨æ–™è®¡ç®—éƒ¨åˆ†ï¼šè¸æ­¥ (TF/TR) - å®Œå…¨æŒ‰ç…§V6.1
    // TF: è¸æ¿æŠ˜æ¿ (Tread Fold)
    const TF_Thickness = thicknesses.treadFold;
    const TF_Width = stepWidth + stepHeight + (constants.hanging * 2) + constants.foldingEdge - (TF_Thickness * 2) - 2;
    const TF_Length = stepLength;
    const TF_Count = totalTreadCount; 

    const TF_UnitMetrics = calculateUnitMetrics(TF_Length, TF_Width, TF_Thickness, materialDensity);
    const TF_TotalArea = TF_UnitMetrics.area * TF_Count;
    const TF_TotalWeight = TF_UnitMetrics.weight * TF_Count;
    
    // TR: è¸æ¿ç­‹æ¿ (Tread Rib)
    const TR_Thickness = thicknesses.treadRib;
    const TR_FoldThickness = thicknesses.treadFold; 
    const TR_Length = stepWidth - (TR_FoldThickness * 2);
    const TR_Width = ((stepHeight + (constants.hanging * 2)) / 2) + constants.foldingEdge - (TR_FoldThickness * 2);
    const TR_Count = totalTreadCount * ribCount; 

    const TR_UnitMetrics = calculateUnitMetrics(TR_Length, TR_Width, TR_Thickness, materialDensity);
    const TR_TotalArea = TR_UnitMetrics.area * TR_Count;
    const TR_TotalWeight = TR_UnitMetrics.weight * TR_Count;

    // ç”¨æ–™è®¡ç®—éƒ¨åˆ†ï¼šå¹³å° (PF/PRib) - å®Œå…¨æŒ‰ç…§V6.1
    // PF: å¹³å°æŠ˜æ¿ (Platform Fold)
    const PF_Thickness = thicknesses.platformFold;
    const PF_Length = stepLength;
    const PF_Width = stepWidth + stepHeight + (constants.hanging * 2) + constants.foldingEdge - (PF_Thickness * 2) - 2;
    const PF_Count = platformCountEquiv; 

    const PF_UnitMetrics = calculateUnitMetrics(PF_Length, PF_Width, PF_Thickness, materialDensity);
    const PF_TotalArea = PF_UnitMetrics.area * PF_Count;
    const PF_TotalWeight = PF_UnitMetrics.weight * PF_Count;
    
    // PRib: å¹³å°ç­‹æ¿ (Platform Rib)
    const PRib_Thickness = thicknesses.platformRib;
    const PRib_FoldThickness = thicknesses.platformFold; 
    const PRib_Length = stepWidth - (PRib_FoldThickness * 2);
    const PRib_Width = ((stepHeight + (constants.hanging * 2)) / 2) + constants.foldingEdge - (PRib_FoldThickness * 2);
    const PRib_Count = platformCountEquiv * ribCount; 

    const PRib_UnitMetrics = calculateUnitMetrics(PRib_Length, PRib_Width, PRib_Thickness, materialDensity);
    const PRib_TotalArea = PRib_UnitMetrics.area * PRib_Count;
    const PRib_TotalWeight = PRib_UnitMetrics.weight * PRib_Count;

    // ä¾§æ¢è®¡ç®—ï¼ˆæ ¹æ®å½¢çŠ¶è°ƒæ•´ï¼‰- å®Œå…¨æŒ‰ç…§V6.1
    let IP_Length, IP_Width, OP_Length, OP_Width;
    
    if (shape === 'straight') {
        // ç›´è·‘æ¢¯ä¾§æ¢è®¡ç®—
        IP_Length = totalEquivalentSteps * stepWidth;
        OP_Length = totalEquivalentSteps * stepWidth;
    } else {
        // èºæ—‹æ¢¯ä¾§æ¢è®¡ç®—
        IP_Length = totalEquivalentSteps * innerStepWidth;
        OP_Length = totalEquivalentSteps * outerStepWidth;
    }

    // ç”¨æ–™è®¡ç®—éƒ¨åˆ†ï¼šä¾§æ¢ - å†…ä¾§æ¿ (IP) - å®Œå…¨æŒ‰ç…§V6.1
    const IP_Thickness = thicknesses.innerPlate;
    const IP_Count = 1;

    // å®½=IF(å†…ä¾§="å•é’¢æ¿",å•é’¢æ¿å‰å£é«˜åº¦,ç»ç’ƒæ§½å‰å£é«˜åº¦)+æ­¥é«˜+ä¸‹æŒ‚+(å°åº•é¾™éª¨+æŠ˜è¾¹)*MAX(è¸æ­¥å†…å†…ä¾§å¡åº¦,å¹³å°å†…å†…ä¾§å¡åº¦)+50
    let IP_BaseHeight = 0;
    if (innerHandrail === 'singlePlate') {
        IP_BaseHeight = constants.singlePlateHeight;
    } else if (innerHandrail === 'glassSlot') {
        IP_BaseHeight = constants.glassSlotHeight;
    } else { // 'boxBeam' - å‡è®¾æŒ‰å•é’¢æ¿é«˜åº¦è®¡ç®—
        IP_BaseHeight = constants.singlePlateHeight; 
    }
    
    const maxInnerSlope = Math.max(slope1_InnerTreadInnerSlope, slope3_InnerPlatformInnerSlope);

    IP_Width = IP_BaseHeight + 
                     stepHeight + 
                     constants.hanging + 
                     (constants.bottomKeel + constants.foldingEdge) * maxInnerSlope + 
                     50;

    const IP_UnitMetrics = calculateUnitMetrics(IP_Length, IP_Width, IP_Thickness, materialDensity);
    const IP_TotalArea = IP_UnitMetrics.area * IP_Count;
    const IP_TotalWeight = IP_UnitMetrics.weight * IP_Count;

    // ä¾§æ¢ - å¤–ä¾§æ¿ (OP) - å®Œå…¨æŒ‰ç…§V6.1
    const OP_Thickness = thicknesses.outerPlate;
    const OP_Count = 1;

    // å®½=IF(å¤–ä¾§æ‰¶æ‰‹="å•é’¢æ¿",å•é’¢æ¿å‰å£é«˜,ç»ç’ƒæ§½å‰å£é«˜)+æ­¥é«˜+ä¸‹æŒ‚+(å°åº•é¾™éª¨+æŠ˜è¾¹)*MAX(è¸æ­¥å¤–å†…ä¾§å¡,å¹³å°å¤–å†…ä¾§å¡)
    let OP_BaseHeight = 0;
    if (outerHandrail === 'singlePlate') {
        OP_BaseHeight = constants.singlePlateHeight;
    } else if (outerHandrail === 'glassSlot') {
        OP_BaseHeight = constants.glassSlotHeight;
    } else { // 'boxBeam' - å‡è®¾æŒ‰å•é’¢æ¿é«˜åº¦è®¡ç®—
        OP_BaseHeight = constants.singlePlateHeight; 
    }
    
    const maxOuterSlope = Math.max(slope2_OuterTreadInnerSlope, slope4_OuterPlatformInnerSlope);

    OP_Width = OP_BaseHeight + 
                     stepHeight + 
                     constants.hanging + 
                     (constants.bottomKeel + constants.foldingEdge) * maxOuterSlope;

    const OP_UnitMetrics = calculateUnitMetrics(OP_Length, OP_Width, OP_Thickness, materialDensity);
    const OP_TotalArea = OP_UnitMetrics.area * OP_Count;
    const OP_TotalWeight = OP_UnitMetrics.weight * OP_Count;

    // ä¾§æ¢ - å†…ä¾§ç®±æ¢å¤– (IBO) - å®Œå…¨æŒ‰ç…§V6.1
    const IBO_Thickness = thicknesses.innerBoxOuter;

    // é•¿=å†…ä¾§æ¿é•¿åº¦-PI()*ç®±æ¢åšåº¦*(æ¥¼æ¢¯èºæ—‹è§’/360)
    const IBO_Length = (shape === 'straight') ? IP_Length : IP_Length - (PI * constants.boxThickness * (stairAngle / 360));

    // å®½=IF(å†…ä¾§="å•é’¢æ¿",å•é’¢æ¿å‰å£é«˜åº¦,ç»ç’ƒæ§½å‰å£é«˜åº¦)+æ­¥é«˜+ä¸‹æŒ‚+(å°åº•é¾™éª¨+æŠ˜è¾¹)*MAX(è¸æ­¥å†…å†…ä¾§å¡åº¦,å¹³å°å†…å†…ä¾§å¡åº¦)+50
    const IBO_Width = IP_Width; // ä¸å†…ä¾§æ¿å®½åº¦ç›¸åŒ

    // æ•°é‡=IF(å†…ä¾§æ‰¶æ‰‹="å•é’¢æ¿",0,1)
    const IBO_Count = (innerHandrail === 'singlePlate') ? 0 : 1;

    const IBO_UnitMetrics = calculateUnitMetrics(IBO_Length, IBO_Width, IBO_Thickness, materialDensity);
    const IBO_TotalArea = IBO_UnitMetrics.area * IBO_Count;
    const IBO_TotalWeight = IBO_UnitMetrics.weight * IBO_Count;

    // ä¾§æ¢ - å†…ä¾§ç®±æ¢ç­‹æ¿ (IBR) - å®Œå…¨æŒ‰ç…§V6.1
    const IBR_Thickness = thicknesses.innerBoxRib;

    // é•¿=å†…ä¾§æ¿å®½åº¦-150
    const IBR_Length = IP_Width - 150;

    // å®½=ç®±æ¢åšåº¦-å†…ä¾§æ¿åšåº¦-å†…ä¾§ç®±æ¢å¤–åšåº¦+10
    const IBR_Width = constants.boxThickness - thicknesses.innerPlate - thicknesses.innerBoxOuter + 10;

    // æ•°é‡=IF(å†…ä¾§æ‰¶æ‰‹="å•é’¢æ¿",0,æ­¥æ•°+(æ­¥å®½æ¯”-1)*å¹³å°æ•°é‡+2)
    const IBR_Count = (innerHandrail === 'singlePlate') ? 0 : 
                     stepCount + (widthRatio - 1) * platformCount + 2;

    const IBR_UnitMetrics = calculateUnitMetrics(IBR_Length, IBR_Width, IBR_Thickness, materialDensity);
    const IBR_TotalArea = IBR_UnitMetrics.area * IBR_Count;
    const IBR_TotalWeight = IBR_UnitMetrics.weight * IBR_Count;

    // ä¾§æ¢ - å¤–ä¾§ç®±æ¢å¤– (OBO) - å®Œå…¨æŒ‰ç…§V6.1
    const OBO_Thickness = thicknesses.outerBoxOuter;

    // é•¿=å¤–ä¾§æ¿é•¿åº¦+PI()*ç®±æ¢åšåº¦*(æ¥¼æ¢¯èºæ—‹è§’/360)
    const OBO_Length = (shape === 'straight') ? OP_Length : OP_Length + (PI * constants.boxThickness * (stairAngle / 360));

    // å®½=IF(å¤–ä¾§æ‰¶æ‰‹="å•é’¢æ¿",å•é’¢æ¿å‰å£é«˜,ç»ç’ƒæ§½å‰å£é«˜)+æ­¥é«˜+ä¸‹æŒ‚+(å°åº•é¾™éª¨+æŠ˜è¾¹)*MAX(è¸æ­¥å¤–å†…ä¾§å¡,å¹³å°å¤–å†…ä¾§å¡)
    const OBO_Width = OP_Width; // ä¸å¤–ä¾§æ¿å®½åº¦ç›¸åŒ

    // æ•°é‡=IF(å¤–ä¾§æ‰¶æ‰‹="å•é’¢æ¿",0,1)
    const OBO_Count = (outerHandrail === 'singlePlate') ? 0 : 1;

    const OBO_UnitMetrics = calculateUnitMetrics(OBO_Length, OBO_Width, OBO_Thickness, materialDensity);
    const OBO_TotalArea = OBO_UnitMetrics.area * OBO_Count;
    const OBO_TotalWeight = OBO_UnitMetrics.weight * OBO_Count;

    // ä¾§æ¢ - å¤–ä¾§ç®±æ¢ç›–æ¿ (OBC) - å®Œå…¨æŒ‰ç…§V6.1
    const OBC_Thickness = thicknesses.outerBoxCover;

    // é•¿=((æ­¥æ•°-å¹³å°æ•°é‡)*æ­¥å®½ï¼ˆå¤–ï¼‰*è¸æ­¥å¤–å†…ä¾§å¡+å¹³å°æ•°é‡*æ­¥å®½æ¯”*æ­¥å®½ï¼ˆå¤–ï¼‰*å¹³å°å¤–å†…ä¾§å¡)
    const OBC_Length_Term1 = (stepCount - platformCount) * outerStepWidth * slope2_OuterTreadInnerSlope;
    const OBC_Length_Term2 = platformCount * widthRatio * outerStepWidth * slope4_OuterPlatformInnerSlope;
    const OBC_Length = OBC_Length_Term1 + OBC_Length_Term2;

    // å®½=ç®±æ¢åšåº¦-å¤–ä¾§æ¿åšåº¦-å¤–ä¾§ç®±æ¢å¤–
    const OBC_Width = constants.boxThickness - thicknesses.outerPlate - thicknesses.outerBoxOuter;

    // æ•°é‡=IF(å¤–ä¾§æ‰¶æ‰‹="å•é’¢æ¿",0,2)
    const OBC_Count = (outerHandrail === 'singlePlate') ? 0 : 2;

    const OBC_UnitMetrics = calculateUnitMetrics(OBC_Length, OBC_Width, OBC_Thickness, materialDensity);
    const OBC_TotalArea = OBC_UnitMetrics.area * OBC_Count;
    const OBC_TotalWeight = OBC_UnitMetrics.weight * OBC_Count;

    // ä¾§æ¢ - å¤–ä¾§ç®±æ¢ç­‹æ¿ (OBR) - å®Œå…¨æŒ‰ç…§V6.1
    const OBR_Thickness = thicknesses.outerBoxRib;

    // é•¿=å¤–ä¾§æ¿å®½åº¦-150
    const OBR_Length = OP_Width - 150;

    // å®½=å°åº•é¾™éª¨-å¤–ä¾§æ¿åšåº¦-å¤–ä¾§ç®±æ¢å¤–åšåº¦+10
    const OBR_Width = constants.bottomKeel - thicknesses.outerPlate - thicknesses.outerBoxOuter + 10;

    // æ•°é‡=IF(å¤–ä¾§æ‰¶æ‰‹="å•é’¢æ¿",0,æ­¥æ•°+(æ­¥å®½æ¯”-1)*å¹³å°æ•°é‡+2)
    const OBR_Count = (outerHandrail === 'singlePlate') ? 0 : 
                     stepCount + (widthRatio - 1) * platformCount + 2;

    const OBR_UnitMetrics = calculateUnitMetrics(OBR_Length, OBR_Width, OBR_Thickness, materialDensity);
    const OBR_TotalArea = OBR_UnitMetrics.area * OBR_Count;
    const OBR_TotalWeight = OBR_UnitMetrics.weight * OBR_Count;

    // ä¾§æ¢ - å†…ä¾§ç®±æ¢ç›–æ¿ (IBC) - å®Œå…¨æŒ‰ç…§V6.1
    const IBC_Thickness = thicknesses.innerBoxCover;

    // (æ­¥æ•°-å¹³å°æ•°é‡) - è®¡ç®—éœ€è¦èµ°è¸æ­¥éƒ¨åˆ†çš„é•¿åº¦
    const treadStepsOnlyForLength = stepCount - platformCount; 

    // é•¿ = ((æ­¥æ•°-å¹³å°æ•°é‡)*æ­¥å®½ï¼ˆå†…ï¼‰*è¸æ­¥å†…å†…ä¾§å¡ + å¹³å°æ•°é‡*æ­¥å®½æ¯”*æ­¥å®½ï¼ˆå†…ï¼‰*å¹³å°å†…å†…ä¾§å¡)
    const IBC_Length_Term1 = treadStepsOnlyForLength * innerStepWidth * slope1_InnerTreadInnerSlope;
    const IBC_Length_Term2 = platformCount * widthRatio * innerStepWidth * slope3_InnerPlatformInnerSlope;
    const IBC_Length = IBC_Length_Term1 + IBC_Length_Term2;

    // å®½ = ç®±æ¢åšåº¦-å¤–ä¾§æ¿åšåº¦-å¤–ä¾§ç®±æ¢å¤–åšåº¦ (ä¸¥æ ¼éµç…§ç”¨æˆ·å…¬å¼)
    const IBC_Width = constants.boxThickness - thicknesses.outerPlate - thicknesses.outerBoxOuter;

    // æ•°é‡ = IF(å†…ä¾§="å•é’¢æ¿",0,2). 
    const IBC_Count = (innerHandrail === 'singlePlate') ? 0 : 2; 

    const IBC_UnitMetrics = calculateUnitMetrics(IBC_Length, IBC_Width, IBC_Thickness, materialDensity);
    const IBC_TotalArea = IBC_UnitMetrics.area * IBC_Count;
    const IBC_TotalWeight = IBC_UnitMetrics.weight * IBC_Count;
    
    // æ–°å¢ï¼šåº•æ¿è®¡ç®— - ä¿®æ”¹åçš„å…¬å¼ - å®Œå…¨æŒ‰ç…§V6.1
    const BP_Thickness = thicknesses.bottomPlate;
    
    // ä¿®æ”¹åçš„åº•æ¿é•¿åº¦å…¬å¼
    const BP_Length = (IBC_Length - innerStepWidth * effectiveLandingSteps + OBC_Length - outerStepWidth * effectiveLandingSteps) / 2 + effectiveLandingSteps * stepHeight - constants.hanging - constants.bottomKeel;
    
    // å®½=æ­¥é•¿
    const BP_Width = stepLength;
    
    // æ•°é‡=1
    const BP_Count = 1;
    
    const BP_UnitMetrics = calculateUnitMetrics(BP_Length, BP_Width, BP_Thickness, materialDensity);
    const BP_TotalArea = BP_UnitMetrics.area * BP_Count;
    const BP_TotalWeight = BP_UnitMetrics.weight * BP_Count;
    
    // å‡†å¤‡ç”¨é‡è¡¨æ ¼æ•°æ®ç»“æ„ - å®Œå…¨æŒ‰ç…§V6.1ï¼Œæ‰€æœ‰ä¾§æ¿éƒ½åŒ…å«
    const materialData = [
        // é¢„åŸ‹æ¿
        { classification: "é¢„åŸ‹æ¿", name: "èµ·æ­¥é¢„åŸ‹æ¿", L: E1_Length, W: E1_Width, T: E1_Thickness, unitArea: E1_UnitMetrics.area, unitWeight: E1_UnitMetrics.weight, count: E1_Count, totalArea: E1_TotalArea, totalWeight: E1_TotalWeight },
        { classification: "é¢„åŸ‹æ¿", name: "å‡ºå£é¢„åŸ‹æ¿", L: E2_Length, W: E2_Width, T: E2_Thickness, unitArea: E2_UnitMetrics.area, unitWeight: E2_UnitMetrics.weight, count: E2_Count, totalArea: E2_TotalArea, totalWeight: E2_TotalWeight },
        { classification: "é¢„åŸ‹æ¿", name: "å‡ºå£æ°´å¹³é¢„åŸ‹æ¿", L: E3_Length, W: E3_Width, T: E3_Thickness, unitArea: E3_UnitMetrics.area, unitWeight: E3_UnitMetrics.weight, count: E3_Count, totalArea: E3_TotalArea, totalWeight: E3_TotalWeight },
        // èµ·æ­¥
        { classification: "èµ·æ­¥", name: "èµ·æ­¥è¸æ¿", L: ST_Length, W: ST_Width, T: ST_Thickness, unitArea: ST_UnitMetrics.area, unitWeight: ST_UnitMetrics.weight, count: ST_Count, totalArea: ST_TotalArea, totalWeight: ST_TotalWeight },
        { classification: "èµ·æ­¥", name: "èµ·æ­¥ç«‹æ¿", L: SR_Length, W: SR_Width, T: SR_Thickness, unitArea: SR_UnitMetrics.area, unitWeight: SR_UnitMetrics.weight, count: SR_Count, totalArea: SR_TotalArea, totalWeight: SR_TotalWeight },
        { classification: "èµ·æ­¥", name: "èµ·æ­¥ç­‹æ¿", L: SRib_Length, W: SRib_Width, T: SRib_Thickness, unitArea: SRib_UnitMetrics.area, unitWeight: SRib_UnitMetrics.weight, count: SRib_Count, totalArea: SRib_TotalArea, totalWeight: SRib_TotalWeight },
        // è¸æ­¥
        { classification: "è¸æ­¥", name: "æŠ˜æ¿", L: TF_Length, W: TF_Width, T: TF_Thickness, unitArea: TF_UnitMetrics.area, unitWeight: TF_UnitMetrics.weight, count: TF_Count, totalArea: TF_TotalArea, totalWeight: TF_TotalWeight },
        { classification: "è¸æ­¥", name: "ç­‹æ¿", L: TR_Length, W: TR_Width, T: TR_Thickness, unitArea: TR_UnitMetrics.area, unitWeight: TR_UnitMetrics.weight, count: TR_Count, totalArea: TR_TotalArea, totalWeight: TR_TotalWeight },
        // å¹³å°
        { classification: "å¹³å°", name: "æŠ˜æ¿", L: PF_Length, W: PF_Width, T: PF_Thickness, unitArea: PF_UnitMetrics.area, unitWeight: PF_UnitMetrics.weight, count: PF_Count, totalArea: PF_TotalArea, totalWeight: PF_TotalWeight },
        { classification: "å¹³å°", name: "ç­‹æ¿", L: PRib_Length, W: PRib_Width, T: PRib_Thickness, unitArea: PRib_UnitMetrics.area, unitWeight: PRib_UnitMetrics.weight, count: PRib_Count, totalArea: PRib_TotalArea, totalWeight: PRib_TotalWeight },
        // å°åº•
        { classification: "å°åº•", name: "åº•æ¿", L: BP_Length, W: BP_Width, T: BP_Thickness, unitArea: BP_UnitMetrics.area, unitWeight: BP_UnitMetrics.weight, count: BP_Count, totalArea: BP_TotalArea, totalWeight: BP_TotalWeight },
        // ä¾§æ¢éƒ¨åˆ† - å†…ä¾§æ¿
        { classification: "ä¾§æ¢", name: "å†…ä¾§æ¿", L: IP_Length, W: IP_Width, T: IP_Thickness, unitArea: IP_UnitMetrics.area, unitWeight: IP_UnitMetrics.weight, count: IP_Count, totalArea: IP_TotalArea, totalWeight: IP_TotalWeight },
        // å†…ä¾§ç®±æ¢å¤–
        { classification: "ä¾§æ¢", name: "å†…ä¾§ç®±æ¢å¤–", L: IBO_Length, W: IBO_Width, T: IBO_Thickness, unitArea: IBO_UnitMetrics.area, unitWeight: IBO_UnitMetrics.weight, count: IBO_Count, totalArea: IBO_TotalArea, totalWeight: IBO_TotalWeight },
        // å†…ä¾§ç®±æ¢ç›–æ¿
        { classification: "ä¾§æ¢", name: "å†…ä¾§ç®±æ¢ç›–æ¿", L: IBC_Length, W: IBC_Width, T: IBC_Thickness, unitArea: IBC_UnitMetrics.area, unitWeight: IBC_UnitMetrics.weight, count: IBC_Count, totalArea: IBC_TotalArea, totalWeight: IBC_TotalWeight },
        // å†…ä¾§ç®±æ¢ç­‹æ¿
        { classification: "ä¾§æ¢", name: "å†…ä¾§ç®±æ¢ç­‹æ¿", L: IBR_Length, W: IBR_Width, T: IBR_Thickness, unitArea: IBR_UnitMetrics.area, unitWeight: IBR_UnitMetrics.weight, count: IBR_Count, totalArea: IBR_TotalArea, totalWeight: IBR_TotalWeight },
        // å¤–ä¾§æ¿
        { classification: "ä¾§æ¢", name: "å¤–ä¾§æ¿", L: OP_Length, W: OP_Width, T: OP_Thickness, unitArea: OP_UnitMetrics.area, unitWeight: OP_UnitMetrics.weight, count: OP_Count, totalArea: OP_TotalArea, totalWeight: OP_TotalWeight },
        // å¤–ä¾§ç®±æ¢å¤–
        { classification: "ä¾§æ¢", name: "å¤–ä¾§ç®±æ¢å¤–", L: OBO_Length, W: OBO_Width, T: OBO_Thickness, unitArea: OBO_UnitMetrics.area, unitWeight: OBO_UnitMetrics.weight, count: OBO_Count, totalArea: OBO_TotalArea, totalWeight: OBO_TotalWeight },
        // å¤–ä¾§ç®±æ¢ç›–æ¿
        { classification: "ä¾§æ¢", name: "å¤–ä¾§ç®±æ¢ç›–æ¿", L: OBC_Length, W: OBC_Width, T: OBC_Thickness, unitArea: OBC_UnitMetrics.area, unitWeight: OBC_UnitMetrics.weight, count: OBC_Count, totalArea: OBC_TotalArea, totalWeight: OBC_TotalWeight },
        // å¤–ä¾§ç®±æ¢ç­‹æ¿
        { classification: "ä¾§æ¢", name: "å¤–ä¾§ç®±æ¢ç­‹æ¿", L: OBR_Length, W: OBR_Width, T: OBR_Thickness, unitArea: OBR_UnitMetrics.area, unitWeight: OBR_UnitMetrics.weight, count: OBR_Count, totalArea: OBR_TotalArea, totalWeight: OBR_TotalWeight },
    ];
    
    // è®¡ç®—æ€»é‡é‡
    const totalWeight = materialData.reduce((sum, item) => sum + item.totalWeight, 0);

    // è¿”å›å®Œæ•´çš„V6.1è®¡ç®—ç»“æœ
    return {
        geometricData: {
            shape,
            outerDiameter,
            stepLength, stepWidth, stepHeight,
            innerDiameter, middleDiameter, stepAngle, innerStepWidth, outerStepWidth,
            totalEquivalentSteps, stairAngle, floorHeight, ribCount,
            stepSlope, inclineAngle
        },
        materialData,
        totalWeight,
        // ç”¨äºæ˜¾ç¤ºå…¬å¼çš„æ•°æ®
        formulas: {
            E1: { L: E1_Length, W: E1_Width, count: E1_Count, term1: E1_Width_Term1 },
            E2: { L: E2_Length, W: E2_Width, count: E2_Count, widthAdd: E2_Width_Add },
            E3: { L: E3_Length, W: E3_Width, count: E3_Count },
            ST: { L: ST_Length, W: ST_Width, count: ST_Count },
            SR: { L: SR_Length, W: SR_Width, count: SR_Count },
            SRib: { L: SRib_Length, W: SRib_Width, count: SRib_Count },
            TF: { L: TF_Length, W: TF_Width, count: TF_Count },
            TR: { L: TR_Length, W: TR_Width, count: TR_Count },
            PF: { L: PF_Length, W: PF_Width, count: PF_Count },
            PRib: { L: PRib_Length, W: PRib_Width, count: PRib_Count },
            BP: { L: BP_Length, W: BP_Width, count: BP_Count },
            IP: { L: IP_Length, W: IP_Width, count: IP_Count, baseHeight: IP_BaseHeight, maxInnerSlope },
            IBO: { L: IBO_Length, W: IBO_Width, count: IBO_Count },
            IBC: { L: IBC_Length, W: IBC_Width, count: IBC_Count, term1: IBC_Length_Term1, term2: IBC_Length_Term2 },
            IBR: { L: IBR_Length, W: IBR_Width, count: IBR_Count },
            OP: { L: OP_Length, W: OP_Width, count: OP_Count, baseHeight: OP_BaseHeight, maxOuterSlope },
            OBO: { L: OBO_Length, W: OBO_Width, count: OBO_Count },
            OBC: { L: OBC_Length, W: OBC_Width, count: OBC_Count, term1: OBC_Length_Term1, term2: OBC_Length_Term2 },
            OBR: { L: OBR_Length, W: OBR_Width, count: OBR_Count }
        },
        sectionType: sectionType, // æ·»åŠ æ¢¯æ®µç±»å‹ä¿¡æ¯
        isOnlySection: isOnlySection,
        isLastMiddleWithoutExit: isLastMiddleWithoutExit,
        isStartSection: isStartSection, // æ·»åŠ æ˜¯å¦ä¸ºèµ·æ­¥æ®µçš„æ ‡å¿—
        effectiveLandingSteps: effectiveLandingSteps // æ·»åŠ æœ‰æ•ˆçš„è½åœ°æ­¥æ•°
    };
}

// æ”¶é›†å…¬å…±å‚æ•°
function collectCommonParameters() {
    const constantsMode = document.querySelector('input[name="constantsMode"]:checked')?.value || 'default';
    const thicknessMode = document.querySelector('input[name="thicknessMode"]:checked')?.value || 'default';
    
    let constants = constantsMode === 'custom' ? {
        materialDensity: Number(document.getElementById("materialDensity").value) || 7850,
        weldAllowance: Number(document.getElementById("weldAllowance").value) || 1.05,
        safeFactor: Number(document.getElementById("safeFactor").value) || 1.20,
        hanging: Number(document.getElementById("hanging").value) || 130,
        foldingEdge: Number(document.getElementById("foldingEdge").value) || 25,
        embedMargin: Number(document.getElementById("embedMargin").value) || 60,
        finishThickness: Number(document.getElementById("finishThickness").value) || 50,
        bottomKeel: Number(document.getElementById("bottomKeel").value) || 40,
        singlePlateHeight: Number(document.getElementById("singlePlateHeight").value) || 1050,
        glassSlotHeight: Number(document.getElementById("glassSlotHeight").value) || 100,
        boxThickness: Number(document.getElementById("boxThickness").value) || 40,
        exitEmbedWidth: Number(document.getElementById("exitEmbedWidth").value) || 500
    } : DEFAULT_CONSTANTS;
    
    let thicknesses = thicknessMode === 'custom' ? {} : DEFAULT_THICKNESSES;
    
    if (thicknessMode === 'custom') {
        const thicknessIds = [
            'embedStart', 'embedExit', 'embedExitFlat',
            'startTread', 'startRiser', 'startRib',
            'treadFold', 'treadRib',
            'platformFold', 'platformRib',
            'bottomPlate',
            'innerPlate', 'innerBoxOuter', 'innerBoxCover', 'innerBoxRib',
            'outerPlate', 'outerBoxOuter', 'outerBoxCover', 'outerBoxRib'
        ];
        
        thicknessIds.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                thicknesses[id] = Number(input.value) || DEFAULT_THICKNESSES[id];
            }
        });
    }
    
    return {
        constantsMode,
        thicknessMode,
        constants,
        thicknesses,
        outerHandrail: document.getElementById("outerHandrail").value,
        innerHandrail: document.getElementById("innerHandrail").value,
        exitLevel: document.getElementById("exitLevel").value
    };
}

// å¼€å§‹è®¡ç®—æ‰€æœ‰æ¢¯æ®µ
function startCalculation() {
    // æ£€æŸ¥æ˜¯å¦è‡³å°‘é…ç½®äº†èµ·æ­¥æ®µ
    if (allSectionsData.length === 0) {
        alert("è¯·å…ˆé…ç½®è‡³å°‘ä¸€ä¸ªæ¢¯æ®µ");
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const btn = document.querySelector('#step2 .btn-next');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading"></span>è®¡ç®—ä¸­...';
    btn.disabled = true;
    
    // æ”¶é›†å…¬å…±å‚æ•°
    globalCommonData = collectCommonParameters();
    
    // å¼€å§‹è®¡ç®—
    setTimeout(() => {
        try {
            calculateAllSections();
        } catch (error) {
            console.error("è®¡ç®—é”™è¯¯:", error);
            document.getElementById("result").innerHTML = `
                <div class="success-message" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}
                </div>
            `;
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }, 100);
}

// è®¡ç®—æ‰€æœ‰æ¢¯æ®µ
function calculateAllSections() {
    calculationResults = [];
    summaryResults = {
        totalWeight: 0,
        totalArea: 0,
        components: {},
        sectionsCount: allSectionsData.length,
        commonData: globalCommonData
    };
    
    let resultHTML = `
        <div class="success-message">
            å¼€å§‹è®¡ç®— ${allSectionsData.length} ä¸ªæ¢¯æ®µ...
        </div>
    `;
    
    document.getElementById("result").innerHTML = resultHTML;
    
    // åˆ†ææ¢¯æ®µé…ç½®
    const hasExitSection = allSectionsData.some(s => s.sectionType === 'exit');
    const isOnlyStartSection = allSectionsData.length === 1 && allSectionsData[0].sectionType === 'start';
    const middleSections = allSectionsData.filter(s => s.sectionType === 'middle');
    const lastMiddleIndex = middleSections.length - 1;
    
    console.log("æ¢¯æ®µé…ç½®åˆ†æ:", {
        hasExitSection,
        isOnlyStartSection,
        middleSectionsCount: middleSections.length,
        lastMiddleIndex
    });
    
    allSectionsData.forEach((section, index) => {
        // å‡†å¤‡é¢å¤–çš„å‚æ•°
        const extraParams = {
            sectionType: section.sectionType, // ä¼ é€’æ­£ç¡®çš„æ¢¯æ®µç±»å‹
            // æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªä¸­é—´æ®µä¸”æ²¡æœ‰å‡ºå£æ®µ
            isLastMiddleWithoutExit: !hasExitSection && 
                                   section.sectionType === 'middle' && 
                                   middleSections.indexOf(section) === lastMiddleIndex,
            // æ˜¯å¦æ˜¯å”¯ä¸€çš„èµ·æ­¥æ®µ
            isOnlySection: isOnlyStartSection && section.sectionType === 'start'
        };
        
        console.log(`æ¢¯æ®µ ${section.title} çš„é¢å¤–å‚æ•°:`, extraParams);
        
        // åˆå¹¶åˆ°å…¬å…±æ•°æ®ä¸­
        const sectionCommonData = {
            ...globalCommonData,
            ...extraParams
        };
        
        // å‡†å¤‡æ•°æ®æ ¼å¼
        const shape = section.modelType === 'circular' ? 'circular' : 'straight';
        
        const data = {
            shape: shape,
            outerDiameter: section.params['p-R'] || 0,
            stepLength: section.params['p-step-length'] || 0,
            stepWidth: section.params['p-w'] || 0,
            stepHeight: section.params['p-h'] || 0,
            stepCount: section.params['p-steps'] || 0,
            platformCount: section.params['p-platforms'] || 0,
            widthRatio: section.params['p-width-ratio'] || 0,
            landingSteps: section.params['p-start-landing'] || 0 // ä½¿ç”¨æ”¶é›†åˆ°çš„å€¼ï¼Œéèµ·æ­¥æ®µä¸º0
        };
        
        // ä½¿ç”¨ä¿®æ”¹åçš„V6.1è®¡ç®—å‡½æ•°
        const sectionResult = calculateV6(data, sectionCommonData);
        
        // å­˜å‚¨ç»“æœ
        calculationResults.push({
            ...section,
            data: data,
            result: sectionResult,
            extraParams: extraParams
        });
        
        // åˆå¹¶åˆ°æ±‡æ€»ç»“æœ
        mergeToSummary(sectionResult, section.title);
    });
    
    // æ˜¾ç¤ºè®¡ç®—ç»“æœ
    displaySortedResults();
    
    // åˆ‡æ¢åˆ°ç¬¬ä¸‰æ­¥
    updateStepIndicator(3);
}

// åˆå¹¶åˆ°æ±‡æ€»ç»“æœ
function mergeToSummary(sectionResult, sectionTitle) {
    sectionResult.materialData.forEach(comp => {
        // åªæ±‡æ€»æœ‰æ•°é‡çš„éƒ¨ä»¶
        if (comp.count <= 0) return;
        
        if (!summaryResults.components[comp.name]) {
            summaryResults.components[comp.name] = {
                name: comp.name,
                classification: comp.classification,
                totalWeight: 0,
                totalArea: 0,
                totalCount: 0,
                sections: [],
                // è®°å½•è§„æ ¼ä¿¡æ¯ï¼ˆå–ç¬¬ä¸€ä¸ªçš„è§„æ ¼ï¼‰
                L: comp.L,
                W: comp.W,
                T: comp.T,
                unitArea: comp.unitArea,
                unitWeight: comp.unitWeight
            };
        }
        
        summaryResults.components[comp.name].totalWeight += comp.totalWeight;
        summaryResults.components[comp.name].totalArea += comp.totalArea;
        summaryResults.components[comp.name].totalCount += comp.count;
        summaryResults.components[comp.name].sections.push({
            section: sectionTitle,
            weight: comp.totalWeight,
            area: comp.totalArea,
            count: comp.count
        });
    });
    
    summaryResults.totalWeight += sectionResult.totalWeight;
    summaryResults.totalArea += sectionResult.materialData.reduce((sum, comp) => sum + comp.totalArea, 0);
}

// æ˜¾ç¤ºæ‰€æœ‰ç»“æœ - æŒ‰é€»è¾‘é¡ºåºæ’åº
function displaySortedResults() {
    // ä½¿ç”¨æ’åºåçš„ç»“æœ
    const sortedResults = sortSectionsByType(calculationResults);
    
    let resultHTML = `
        <div class="success-message">
            âœ… è®¡ç®—å®Œæˆï¼å…±è®¡ç®—äº† ${allSectionsData.length} ä¸ªæ¢¯æ®µ
        </div>
        <div class="info-message">
            ğŸ“‹ æ³¨æ„ï¼šç»“æœå·²æŒ‰é€»è¾‘é¡ºåºæ’åˆ—ï¼ˆèµ·æ­¥æ®µ â†’ ä¸­é—´æ®µ â†’ å‡ºå£æ®µï¼‰
        </div>
    `;
    
    // æ˜¾ç¤ºå„æ¢¯æ®µç»“æœ
    resultHTML += `<h3>ğŸ“Š å„æ¢¯æ®µè®¡ç®—ç»“æœï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹å®Œæ•´V6.1ç»“æœï¼‰</h3>`;
    
    sortedResults.forEach((result, index) => {
        const sectionResult = result.result;
        const modelTypeName = result.modelType === 'circular' ? 'æ­£åœ†æ¨¡å‹' : 'ç›´æ¢¯æ¨¡å‹';
        const sectionTypeIcon = result.sectionType === 'start' ? 'ğŸš€' : 
                              result.sectionType === 'middle' ? 'ğŸ”„' : 'ğŸ';
        
        // æ˜¾ç¤ºä¿®æ­£åçš„è½åœ°æ­¥æ•°
        const landingStepsDisplay = result.result.effectiveLandingSteps;
        const landingStepsInfo = result.sectionType === 'start' ? 
            `<span style="font-size: 0.9em; color: var(--gray); margin-left: 10px;">è½åœ°æ­¥æ•°: ${landingStepsDisplay}</span>` : '';
        
        resultHTML += `
            <div class="section-result">
                <div class="section-result-header" onclick="toggleSectionResult(${result.index})">
                    <div>
                        <strong>${result.title}</strong>
                        <span style="margin-left: 10px; padding: 2px 8px; background: ${result.modelType === 'circular' ? '#dbeafe' : '#dcfce7'}; color: ${result.modelType === 'circular' ? '#1d4ed8' : '#059669'}; border-radius: 4px; font-size: 12px;">
                            ${modelTypeName}
                        </span>
                        <span style="margin-left: 5px; padding: 2px 8px; background: ${result.sectionType === 'start' ? '#fef3c7' : result.sectionType === 'middle' ? '#dbeafe' : '#dcfce7'}; color: ${result.sectionType === 'start' ? '#92400e' : result.sectionType === 'middle' ? '#1e40af' : '#065f46'}; border-radius: 4px; font-size: 12px;">
                            ${result.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : result.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ'}
                        </span>
                        <span style="margin-left: 5px; padding: 2px 8px; background: #f3f4f6; color: #6b7280; border-radius: 4px; font-size: 12px;">
                            é€»è¾‘é¡ºåº: ${index + 1}
                        </span>
                        ${landingStepsInfo}
                    </div>
                    <div>
                        <span style="color: var(--gray); margin-right: 10px;">æ€»é‡é‡: <strong>${sectionResult.totalWeight.toFixed(1)} kg</strong></span>
                        <span>${sectionTypeIcon}</span>
                    </div>
                </div>
                <div class="section-result-content" id="section-content-${result.index}">
                    ${generateV6ResultDisplay(result)}
                </div>
            </div>
        `;
    });
    
    document.getElementById("result").innerHTML = resultHTML;
    
    // æ¸²æŸ“MathJaxå…¬å¼
    if (window.MathJax) {
        window.MathJax.typesetPromise();
    }
}

// ç”ŸæˆV6.1å®Œæ•´ç»“æœæ˜¾ç¤º
function generateV6ResultDisplay(result) {
    const sectionResult = result.result;
    const data = result.data;
    const commonData = globalCommonData;
    const isCircular = result.modelType === 'circular';
    
    const constantsMode = commonData.constantsMode;
    const thicknessMode = commonData.thicknessMode;
    const constants = commonData.constants;
    const thicknesses = commonData.thicknesses;
    
    const stepLength = data.stepLength;
    const stepWidth = data.stepWidth;
    const stepHeight = data.stepHeight;
    const outerDiameter = data.outerDiameter;
    
    const embedMargin = constants.embedMargin;
    const hanging = constants.hanging;
    const foldingEdge = constants.foldingEdge;
    
    const innerDiameter = sectionResult.geometricData.innerDiameter || 0;
    const middleDiameter = sectionResult.geometricData.middleDiameter || 0;
    const stepAngle = sectionResult.geometricData.stepAngle || 0;
    const innerStepWidth = sectionResult.geometricData.innerStepWidth || stepWidth;
    const outerStepWidth = sectionResult.geometricData.outerStepWidth || stepWidth;
    const totalEquivalentSteps = sectionResult.geometricData.totalEquivalentSteps;
    const stairAngle = sectionResult.geometricData.stairAngle || 0;
    const floorHeight = sectionResult.geometricData.floorHeight;
    const ribCount = sectionResult.geometricData.ribCount;
    
    const totalTreadCount = data.stepCount - sectionResult.effectiveLandingSteps - data.platformCount;
    const platformCountEquiv = data.platformCount * data.widthRatio;
    
    const formulas = sectionResult.formulas;
    
    // è¿™é‡Œåº”è¯¥è°ƒç”¨V6.1çš„æ˜¾ç¤ºå‡½æ•°ï¼Œä½†ä¸ºäº†ç®€æ´ï¼Œæˆ‘ä»¬ç›´æ¥ç”ŸæˆHTML
    return `
        <h3>âœ… è®¡ç®—æ¨¡å¼æ‘˜è¦</h3>
        <p>å½“å‰è®¡ç®—ä½¿ç”¨: <strong>${isCircular ? 'æ­£åœ†èºæ—‹æ¢¯' : 'ç›´è·‘æ¥¼æ¢¯'}</strong> + <strong>${constantsMode === 'custom' ? 'è‡ªå®šä¹‰å¸¸é‡' : 'é»˜è®¤å¸¸é‡'}</strong> + <strong>${thicknessMode === 'custom' ? 'è‡ªå®šä¹‰åšåº¦' : 'é»˜è®¤åšåº¦'}</strong>ã€‚</p>
        
        <div style="margin: 20px 0; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--primary);">
            <p><strong>æ¢¯æ®µç±»å‹:</strong> ${result.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : result.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ'}</p>
            <p><strong>æœ‰æ•ˆè½åœ°æ­¥æ•°:</strong> ${sectionResult.effectiveLandingSteps} ${result.sectionType === 'start' ? '(èµ·æ­¥æ®µ)' : '(éèµ·æ­¥æ®µï¼Œä¸º0)'}</p>
            <p><strong>æ˜¯å¦ä¸ºèµ·æ­¥æ®µ:</strong> ${sectionResult.isStartSection ? 'æ˜¯' : 'å¦'}</p>
        </div>
        
        <br>
        
        <h3>ğŸ“ å½“å‰è®¡ç®—ä½¿ç”¨çš„ã€å¸¸é‡å‚æ•°ã€‘ï¼š</h3>
        <div class="constants-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="constants-group" style="background: var(--light); padding: 20px; border-radius: 8px; border: 1px solid var(--gray-light);">
                <h4 style="margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--gray-light); padding-bottom: 10px;">ææ–™åŠå®‰å…¨å‚æ•°:</h4>
                <pre style="margin: 0; white-space: pre-wrap; font-family: inherit;">é’¢æå¯†åº¦: ${constants.materialDensity} kg/mÂ³
ç„Šç¼ä½™é‡: ${constants.weldAllowance}
å®‰å…¨ç³»æ•°: ${constants.safeFactor}</pre>
            </div>
            <div class="constants-group" style="background: var(--light); padding: 20px; border-radius: 8px; border: 1px solid var(--gray-light);">
                <h4 style="margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--gray-light); padding-bottom: 10px;">æ„é€ åŠæ”¾æ ·å°ºå¯¸ (å•ä½: mm):</h4>
                <pre style="margin: 0; white-space: pre-wrap; font-family: inherit;">ä¸‹æŒ‚: ${hanging}
æŠ˜è¾¹: ${foldingEdge}
é¢„åŸ‹æ”¾è¾¹: ${embedMargin}
é¥°é¢åšåº¦: ${constants.finishThickness}
å°åº•é¾™éª¨: ${constants.bottomKeel}</pre>
            </div>
            <div class="constants-group" style="background: var(--light); padding: 20px; border-radius: 8px; border: 1px solid var(--gray-light);">
                <h4 style="margin-top: 0; color: var(--primary); border-bottom: 1px solid var(--gray-light); padding-bottom: 10px;">ä¾§æ¢æˆªé¢å‚æ•° (å•ä½: mm):</h4>
                <pre style="margin: 0; white-space: pre-wrap; font-family: inherit;">å•é’¢æ¿å‰å£é«˜: ${constants.singlePlateHeight}
ç»ç’ƒæ§½å‰å£é«˜: ${constants.glassSlotHeight}
ç®±æ¢åšåº¦: ${constants.boxThickness}
å‡ºå£é¢„åŸ‹æ¿å®½åº¦: ${constants.exitEmbedWidth}</pre>
            </div>
        </div>
        
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 25px 0;">
        <h3>ğŸ“Š ${isCircular ? 'æ­£åœ†èºæ—‹æ¢¯' : 'ç›´è·‘æ¥¼æ¢¯'}é’¢æ¿ç”¨é‡è®¡ç®—</h3>
        ${generateMaterialTableV6(sectionResult.materialData, sectionResult.totalWeight, isCircular)}
        
        <div style="margin-top: 30px; text-align: center;">
            <div class="export-buttons">
                <button onclick="exportSingleToExcel(${result.index})" class="export-btn excel">
                    <span class="icon">ğŸ“Š</span>
                    <span>å¯¼å‡ºæœ¬æ¢¯æ®µExcelæŠ¥å‘Š</span>
                </button>
            </div>
        </div>
    `;
}

// ç”ŸæˆV6.1ç”¨é‡è¡¨æ ¼ - æ˜¾ç¤ºæ‰€æœ‰ä¾§æ¿æ•°æ®
function generateMaterialTableV6(materialData, totalWeight, isCircular) {
    let tableBody = '';

    // åˆ†ç±»åˆ†ç»„ (ç”¨äº rowspan)
    const classifications = {};
    materialData.forEach(item => {
        // å³ä½¿æ•°é‡ä¸º0ä¹Ÿæ˜¾ç¤º
        classifications[item.classification] = (classifications[item.classification] || 0) + 1;
    });

    for (let i = 0; i < materialData.length; i++) {
        const item = materialData[i];
        
        // ä¸å†è·³è¿‡æ•°é‡ä¸º0çš„éƒ¨ä»¶ï¼Œå…¨éƒ¨æ˜¾ç¤º
        
        let classificationCell = '';
        // åªæœ‰åˆ†ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ éœ€è¦æ·»åŠ  rowspan
        if (classifications[item.classification] > 0 && classifications[item.classification] !== -1) {
            classificationCell = `<td rowspan="${classifications[item.classification]}">${item.classification}</td>`;
            classifications[item.classification] = -1; // æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œé˜²æ­¢é‡å¤
        }
        
        // ä¿®æ­£ï¼šå¦‚æœ count æ˜¯æ•´æ•°ï¼Œå»æ‰ .000ï¼Œå¦åˆ™ä¿ç•™ä¸‰ä½å°æ•°
        const countDisplay = (item.count % 1 === 0) ? item.count.toFixed(0) : item.count.toFixed(3);
        
        // å¦‚æœæ•°é‡ä¸º0ï¼Œç”¨ç°è‰²æ˜¾ç¤º
        const countStyle = item.count === 0 ? 'style="color: #94a3b8; font-style: italic;"' : '';
        const weightStyle = item.count === 0 ? 'style="color: #94a3b8; font-style: italic;"' : '';

        // åšåº¦æ˜¾ç¤ºä¸ºæ•´æ•°
        const thicknessDisplay = Math.round(item.T);

        tableBody += `
            <tr>
                ${classificationCell}
                <td>${item.name}</td>
                <td>${Math.ceil(item.L)}</td>
                <td>${Math.ceil(item.W)}</td>
                <td>${thicknessDisplay}</td>
                <td>${item.unitArea.toFixed(3)}</td>
                <td>${item.unitWeight.toFixed(3)}</td>
                <td ${countStyle}>${countDisplay}</td> 
                <td>${item.totalArea.toFixed(3)}</td>
                <td ${weightStyle}>${item.totalWeight.toFixed(1)}</td> 
            </tr>
        `;
    }

    return `
        <table class="material-table">
            <thead>
                <tr>
                    <th rowspan="2" colspan="2">é’¢æ¿æ•°é‡</th>
                    <th colspan="3">è§„æ ¼ (å•ä½: mm)</th>
                    <th colspan="2" class="unit-quota-header">å•ä½å®šé¢</th>
                    <th colspan="3" class="quantity-stats-header">æ•°é‡ç»Ÿè®¡</th>
                </tr>
                <tr>
                    <th>é•¿</th>
                    <th>å®½</th>
                    <th>åš</th>
                    <th>é¢ç§¯ (mÂ²)</th>
                    <th>é‡é‡ (kg)</th>
                    <th>æ•°é‡</th>
                    <th>é¢ç§¯ (mÂ²)</th>
                    <th>é‡é‡ (kg)</th>
                </tr>
                <tr>
                    <th>åˆ†ç±»</th>
                    <th>åç§°</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                ${tableBody}
                <tr class="total-row">
                    <td colspan="7" class="total-label">åˆè®¡é‡é‡</td>
                    <td colspan="3" class="final-weight">${totalWeight.toFixed(1)} kg</td>
                </tr>
            </tbody>
        </table>
    `;
}

// ==================== ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š ====================
function showSummaryReport() {
    updateStepIndicator(4);
    
    // ä½¿ç”¨æ’åºåçš„ç»“æœ
    const sortedResults = sortSectionsByType(calculationResults);
    
    let summaryHTML = `
        <div style="margin-top: 20px;">
            <div class="info-message">
                ğŸ“‹ æ³¨æ„ï¼šæ‰€æœ‰æ¢¯æ®µå·²æŒ‰é€»è¾‘é¡ºåºæ’åˆ—ï¼ˆèµ·æ­¥æ®µ â†’ ä¸­é—´æ®µ â†’ å‡ºå£æ®µï¼‰
            </div>
            
            <div class="summary-result">
                <h4>ğŸ“ˆ å·¥ç¨‹æ€»é‡æ±‡æ€»</h4>
                <p>æ€»è®¡ <strong>${summaryResults.sectionsCount}</strong> ä¸ªæ¢¯æ®µï¼Œåˆå¹¶ç›¸åŒéƒ¨ä»¶åçš„æ€»é‡ç»Ÿè®¡ï¼š</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--primary); text-align: center;">
                        <div style="font-size: 0.9rem; color: var(--gray);">æ€»é‡é‡</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${summaryResults.totalWeight.toFixed(1)} kg</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--secondary); text-align: center;">
                        <div style="font-size: 0.9rem; color: var(--gray);">æ€»é¢ç§¯</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--secondary);">${summaryResults.totalArea.toFixed(3)} mÂ²</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--accent); text-align: center;">
                        <div style="font-size: 0.9rem; color: var(--gray);">éƒ¨ä»¶ç§ç±»</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--accent);">${Object.keys(summaryResults.components).length} ç§</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <h4>ğŸ“Š éƒ¨ä»¶ç”¨é‡æ±‡æ€»è¡¨</h4>
                <table class="material-table">
                    <thead>
                        <tr>
                            <th>åˆ†ç±»</th>
                            <th>éƒ¨ä»¶åç§°</th>
                            <th>è§„æ ¼ (mm)</th>
                            <th>æ€»æ•°é‡</th>
                            <th>å•ä½é¢ç§¯ (mÂ²)</th>
                            <th>å•ä½é‡é‡ (kg)</th>
                            <th>æ€»é¢ç§¯ (mÂ²)</th>
                            <th>æ€»é‡é‡ (kg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(summaryResults.components).map(comp => `
                            <tr>
                                <td>${comp.classification}</td>
                                <td>${comp.name}</td>
                                <td>${Math.ceil(comp.L)}Ã—${Math.ceil(comp.W)}Ã—${comp.T}</td>
                                <td>${comp.totalCount}</td>
                                <td>${comp.unitArea.toFixed(3)}</td>
                                <td>${comp.unitWeight.toFixed(3)}</td>
                                <td>${comp.totalArea.toFixed(3)}</td>
                                <td>${comp.totalWeight.toFixed(1)}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="6"><strong>å·¥ç¨‹æ€»é‡åˆè®¡</strong></td>
                            <td><strong>${summaryResults.totalArea.toFixed(3)}</strong></td>
                            <td><strong>${summaryResults.totalWeight.toFixed(1)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 40px;">
                <h4>ğŸ“ˆ å„æ¢¯æ®µè´¡çŒ®æ¯”ä¾‹ï¼ˆæŒ‰é€»è¾‘é¡ºåºï¼‰</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                    ${sortedResults.map((result, index) => {
                        const weight = result.result.totalWeight;
                        const percentage = summaryResults.totalWeight > 0 ? (weight / summaryResults.totalWeight * 100).toFixed(1) : 0;
                        return `
                            <div style="padding: 15px; background: var(--light); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>
                                        <strong>${result.title}</strong>
                                        <span style="margin-left: 8px; padding: 2px 6px; background: #f3f4f6; color: #6b7280; border-radius: 4px; font-size: 11px;">
                                            é¡ºåº: ${index + 1}
                                        </span>
                                    </span>
                                    <span>${percentage}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--gray); margin-bottom: 5px;">
                                    <span>${result.modelType === 'circular' ? 'æ­£åœ†æ¨¡å‹' : 'ç›´æ¢¯æ¨¡å‹'} Â· ${result.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : result.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ'}</span>
                                    <span>${weight.toFixed(1)} kg</span>
                                </div>
                                <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${percentage}%; background: ${index % 3 === 0 ? 'var(--primary)' : index % 3 === 1 ? 'var(--secondary)' : 'var(--accent)'};"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="export-buttons" style="margin-top: 40px;">
                <button onclick="exportSummaryToExcel()" class="export-btn excel">
                    <span class="icon">ğŸ“Š</span>
                    <span>å¯¼å‡ºExcelæ±‡æ€»æŠ¥å‘Š</span>
                </button>
                
                <button onclick="exportSummaryToTXT()" class="export-btn txt">
                    <span class="icon">ğŸ“</span>
                    <span>å¯¼å‡ºæ–‡æœ¬æ±‡æ€»æŠ¥å‘Š</span>
                </button>
            </div>
        </div>
    `;
    
    document.getElementById("summaryResult").innerHTML = summaryHTML;
}

// ==================== ç•Œé¢äº¤äº’åŠŸèƒ½ ====================
// åˆ‡æ¢æ¢¯æ®µç»“æœæ˜¾ç¤º
function toggleSectionResult(index) {
    const content = document.getElementById(`section-content-${index}`);
    if (content.classList.contains('show')) {
        content.classList.remove('show');
    } else {
        content.classList.add('show');
    }
}

// ==================== å¯¼å‡ºåŠŸèƒ½ ====================
// å¯¼å‡ºå•ä¸ªæ¢¯æ®µæŠ¥å‘Š
function exportSingleToExcel(index) {
    const result = calculationResults[index];
    if (!result) return;
    
    try {
        const wb = XLSX.utils.book_new();
        const wsData = XLSX.utils.table_to_sheet(document.querySelector(`#section-content-${index} .material-table`));
        XLSX.utils.book_append_sheet(wb, wsData, `${result.title}ç”¨é‡`);
        
        const fileName = `æ¢¯æ®µ_${result.title}_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showExportSuccess(`${result.title} ExcelæŠ¥å‘Šå·²ç”Ÿæˆï¼`);
    } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
}

// å¯¼å‡ºæ±‡æ€»æŠ¥å‘Šåˆ°Excel
function exportSummaryToExcel() {
    try {
        const wb = XLSX.utils.book_new();
        
        // 1. åˆ›å»ºæ±‡æ€»å·¥ä½œè¡¨
        const summaryData = [
            ['æ¥¼æ¢¯åˆ†æ®µæµ‹ç®—æ±‡æ€»æŠ¥å‘Š'],
            ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString()],
            ['æ¢¯æ®µæ€»æ•°', summaryResults.sectionsCount],
            ['æ€»é‡é‡ (kg)', summaryResults.totalWeight.toFixed(1)],
            ['æ€»é¢ç§¯ (mÂ²)', summaryResults.totalArea.toFixed(3)],
            ['éƒ¨ä»¶ç§ç±»', Object.keys(summaryResults.components).length],
            [''],
            ['å„æ¢¯æ®µä¿¡æ¯ï¼ˆæŒ‰é€»è¾‘é¡ºåºï¼‰'],
            ['é€»è¾‘é¡ºåº', 'æ¢¯æ®µåç§°', 'æ¨¡å‹ç±»å‹', 'æ¢¯æ®µç±»å‹', 'é‡é‡ (kg)', 'å æ¯” (%)']
        ];
        
        const sortedResults = sortSectionsByType(calculationResults);
        sortedResults.forEach((result, index) => {
            const weight = result.result.totalWeight;
            const percentage = summaryResults.totalWeight > 0 ? (weight / summaryResults.totalWeight * 100).toFixed(1) : 0;
            summaryData.push([
                index + 1,
                result.title,
                result.modelType === 'circular' ? 'æ­£åœ†æ¨¡å‹' : 'ç›´æ¢¯æ¨¡å‹',
                result.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : result.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ',
                weight.toFixed(1),
                percentage
            ]);
        });
        
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        
        // 2. åˆ›å»ºéƒ¨ä»¶æ±‡æ€»å·¥ä½œè¡¨
        const componentData = [
            ['éƒ¨ä»¶ç”¨é‡æ±‡æ€»'],
            ['åˆ†ç±»', 'éƒ¨ä»¶åç§°', 'è§„æ ¼ (mm)', 'æ€»æ•°é‡', 'å•ä½é¢ç§¯ (mÂ²)', 'å•ä½é‡é‡ (kg)', 'æ€»é¢ç§¯ (mÂ²)', 'æ€»é‡é‡ (kg)']
        ];
        
        Object.values(summaryResults.components).forEach(comp => {
            componentData.push([
                comp.classification,
                comp.name,
                `${Math.ceil(comp.L)}Ã—${Math.ceil(comp.W)}Ã—${comp.T}`,
                comp.totalCount,
                comp.unitArea.toFixed(3),
                comp.unitWeight.toFixed(3),
                comp.totalArea.toFixed(3),
                comp.totalWeight.toFixed(1)
            ]);
        });
        
        componentData.push(['', '', '', '', '', '', 'åˆè®¡', summaryResults.totalWeight.toFixed(1)]);
        
        const wsComponents = XLSX.utils.aoa_to_sheet(componentData);
        
        // 3. æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
        XLSX.utils.book_append_sheet(wb, wsSummary, 'æ±‡æ€»ä¿¡æ¯');
        XLSX.utils.book_append_sheet(wb, wsComponents, 'éƒ¨ä»¶æ±‡æ€»');
        
        // ä¿å­˜Excelæ–‡ä»¶
        const fileName = `æ¥¼æ¢¯åˆ†æ®µæ±‡æ€»æŠ¥å‘Š_${new Date().getTime()}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showExportSuccess('Excelæ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ï¼');
        
    } catch (error) {
        console.error('ç”ŸæˆExcelå¤±è´¥:', error);
        alert('ç”ŸæˆExcelæ±‡æ€»æŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯ï¼š' + error.message);
    }
}

// å¯¼å‡ºæ±‡æ€»æŠ¥å‘Šåˆ°TXT
function exportSummaryToTXT() {
    try {
        const sortedResults = sortSectionsByType(calculationResults);
        
        let reportContent = '='.repeat(70) + '\n';
        reportContent += 'æ¥¼æ¢¯åˆ†æ®µæµ‹ç®—æ±‡æ€»æŠ¥å‘Š\n';
        reportContent += '='.repeat(70) + '\n\n';
        
        // åŸºæœ¬ä¿¡æ¯
        reportContent += 'ã€åŸºæœ¬ä¿¡æ¯ã€‘\n';
        reportContent += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n`;
        reportContent += `æ¢¯æ®µæ€»æ•°: ${summaryResults.sectionsCount}\n`;
        reportContent += `æ€»é‡é‡: ${summaryResults.totalWeight.toFixed(1)} kg\n`;
        reportContent += `æ€»é¢ç§¯: ${summaryResults.totalArea.toFixed(3)} mÂ²\n`;
        reportContent += `éƒ¨ä»¶ç§ç±»: ${Object.keys(summaryResults.components).length} ç§\n\n`;
        
        // å„æ¢¯æ®µä¿¡æ¯ï¼ˆæŒ‰é€»è¾‘é¡ºåºï¼‰
        reportContent += 'ã€å„æ¢¯æ®µä¿¡æ¯ï¼ˆæŒ‰é€»è¾‘é¡ºåºï¼‰ã€‘\n';
        reportContent += '-'.repeat(100) + '\n';
        sortedResults.forEach((result, index) => {
            const weight = result.result.totalWeight;
            const percentage = summaryResults.totalWeight > 0 ? (weight / summaryResults.totalWeight * 100).toFixed(1) : 0;
            reportContent += `${(index + 1).toString().padStart(2)}. ${result.title.padEnd(15)} ${(result.modelType === 'circular' ? 'æ­£åœ†' : 'ç›´æ¢¯').padEnd(8)} ${(result.sectionType === 'start' ? 'èµ·æ­¥æ®µ' : result.sectionType === 'middle' ? 'ä¸­é—´æ®µ' : 'å‡ºå£æ®µ').padEnd(8)} ${weight.toFixed(1).padStart(8)} kg ${percentage.padStart(5)}%\n`;
        });
        
        reportContent += '\nã€éƒ¨ä»¶ç”¨é‡æ±‡æ€»ã€‘\n';
        reportContent += '-'.repeat(120) + '\n';
        
        Object.values(summaryResults.components).forEach(comp => {
            reportContent += `${comp.classification.padEnd(8)} ${comp.name.padEnd(15)} ${Math.ceil(comp.L).toString().padStart(6)}Ã—${Math.ceil(comp.W).toString().padStart(6)}Ã—${comp.T.toString().padStart(3)} mm æ•°é‡: ${comp.totalCount.toString().padStart(4)} é‡é‡: ${comp.totalWeight.toFixed(1).padStart(8)} kg\n`;
        });
        
        reportContent += '\n' + '='.repeat(70) + '\n';
        reportContent += 'æ¥¼æ¢¯åˆ†æ®µæµ‹ç®—ç³»ç»Ÿ V7.0 - å¤šæ¢¯æ®µæ•´åˆç‰ˆ\n';
        reportContent += '='.repeat(70) + '\n';
        
        // åˆ›å»ºBlobå¹¶ä¸‹è½½
        const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `æ¥¼æ¢¯åˆ†æ®µæ±‡æ€»æŠ¥å‘Š_${new Date().getTime()}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showExportSuccess('æ–‡æœ¬æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½ï¼');
        
    } catch (error) {
        console.error('ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Šå¤±è´¥:', error);
        alert('ç”Ÿæˆæ–‡æœ¬æ±‡æ€»æŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯ï¼š' + error.message);
    }
}

// æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæ¶ˆæ¯
function showExportSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.style.animation = 'fadeIn 0.5s ease';
    successDiv.innerHTML = `
        <span style="font-size: 20px; margin-right: 10px;">âœ“</span>
        <span>${message}</span>
    `;
    
    const currentStep = document.querySelector('.step-active').id;
    const resultArea = document.getElementById(currentStep === 'step4' ? 'summaryResult' : 'result');
    resultArea.insertBefore(successDiv, resultArea.firstChild);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.style.opacity = '0';
            successDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 500);
        }
    }, 3000);
}
</script>
</body>
</html>